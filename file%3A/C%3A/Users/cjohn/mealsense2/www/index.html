<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Meal Sense 2</title>
    
    <!-- Framework7 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.css">
    
    <!-- Custom styles -->
    <style>
        :root {
            --f7-theme-color: #610000;
            --f7-theme-color-rgb: 99, 102, 241;
            --f7-theme-color-shade: #660303;
            --f7-theme-color-tint: #640505;
            --f7-safe-area-left: 0px;
            --f7-safe-area-right: 0px;
            /* App background color (tuned to image red) */
            --app-bg-color: #610000;
        }
        
        .item-thumbnail {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0px solid #610000;
            background: #610000;
            border-radius: 0px;
        }
        
        .item-thumbnail img {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border: 0px solid #610000;
            background: #610000;
            border-radius: 0px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .quantity-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: #374151;
            border: 0px solid #610000;
            background: #610000;
            border-radius: 0px;
        }
        .quantity-btn img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            display: block;
            border: 0px none #610000;
            background: #610000;
            border-radius: 0px;
        }
        
        .button img {
            height: 20px;
            width: auto;
            object-fit: contain;
            vertical-align: middle;
            border: none;
        }
        
        .button-small img {
            height: 100%;
            width: 100%;
            object-fit: cover;
            border: none;
        }
        
        .button-large img {
            height: 100%;
            width: 100%;
            object-fit: cover;
            vertical-align: middle;
            border: none;
        }
        
        .button-outline {
            border: 0px solid currentColor;
        }
        
        .button-outline img {
            border: none !important;
        }
        
        .button-fill {
            border: none;
        }
        
        .button-fill img {
            border: none !important;
        }
        
        label.button img {
            border: none !important;
        }
        
        .quantity-value {
            min-width: 24px;
            text-align: center;
            font-weight: 600;
        }
        
        .expired-item {
            background: #fee2e2 !important;
        }
        
        .expiring-soon-item {
            background: #fef3c7 !important;
        }
        
        .scan-preview-box {
            width: 100%;
            height: 200px;
            border: 2px dashed #000000;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #444444;
        }
        
        .scan-preview-img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 0px;
        }

        /* Apply red background across main containers */
        body,
        .view,
        .page,
        .page-content {
            background-color: #44130e !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Main View -->
        <div class="view view-main view-init safe-areas" data-master-detail-breakpoint="768">
            <!-- Top Navbar -->
            <div class="navbar">
                <div style="background-color: #610000;"></div>
                <div class="navbar-inner" style="background-color: #610000;">
                    <div class="title">Smart Pantry Chef</div>
                </div>
            </div>
            
            <!-- Toolbar/Tabs -->
            <div class="toolbar toolbar-bottom tabbar">
                <div class="toolbar-inner">
                    <a href="#tab-inventory" class="tab-link tab-link-active">
                        <i class="icon" style="width: 100px; height: 45px;"><img src="img/inventory.jpg" alt="Inventory" style="width: 100%; height: 60px;"></i>
                    </a>
                    <a href="#tab-recipes" class="tab-link">
                        <i class="icon" style="width: 100px; height: 45px;"><img src="img/recipes.jpg" alt="Recipes" style="width: 25%; height: 60px;"></i>
                    </a>
                    <a href="#tab-schedule" class="tab-link">
                        <i class="icon" style="width: 100px; height: 45px;"><img src="img/schedule.jpg" alt="Schedule" style="width: 25%; height: 60px;"></i>
                    </a>
                    <a href="#tab-shopping" class="tab-link">
                        <i class="icon" style="width: 100px; height: 45px;"><img src="img/shopping.jpg" alt="Shopping" style="width: 25%; height: 60px;"></i>
                    </a>
                </div>
            </div>
            
            <!-- Page content with tabs -->
            <div class="page">
                <div class="tabs">
                    <!-- Inventory Tab -->
                    <div id="tab-inventory" class="tab tab-active page-content">
                        <!-- Scanner Section -->
                        <div class="card" style="color: #610000;">
                            <div class="card-content card-content-padding">
                                <div id="scan-preview-container" style="color: #610000;" class="scan-preview-box">
                                    <div id="scan-placeholder">
                                        <i class="f7-icons" style="font-size: 48px; color: #94a3b8;">camera</i>
                                        <p style="color: #575555; margin-top: 8px;">No image selected</p>
                                    </div>
                                    <img id="scan-preview" class="scan-preview-img" style="display: none;">
                                </div>
                                <div class="row" style="color: #610000">
                                    <div class="col-50" style="vertical-align: middle;">
                                        <label style="cursor: pointer;">
                                            <img src="img/scanimage.jpg" style="vertical-align: middle; height: 50px;" alt="Camera Capture">
                                            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
                                        </label>
                                         <label class="button[disabled]" style="cursor: pointer;">
                                            <img src="img/photogallery.jpg" style="vertical-align: middle; height: 50px;" alt="Gallery">
                                            <input type="file" id="file-input" accept="image/*" style="display: none;">
                                        </label>
                                          <label class="button[disabled]" style="cursor: pointer;">
                                    <img src="img/analyze.jpg" style="vertical-align: middle; height: 50px;" alt="Scan Image">
                               
                                </label>
                                    </div>
                                <div id="scan-status" class="text-align-center" style="display: none; margin-top: 16px;">
                                    <div class="preloader"></div>
                                    <p id="scan-status-text" style="margin-top: 8px; color: #6366f1;">Analyzing...</p>
                                </div>
                                <div id="scan-error" class="block-footer" style="display: none; color: #ef4444; margin-top: 12px;"></div>
                            </div>
                        </div>
                        
                        <!-- Detection Results -->
                        <div id="detection-result" style="display: none;">
                            <div class="block-title">Detected Items</div>
                            <div class="list">
                                <ul id="detected-items-list"></ul>
                            </div>
                            <div class="block">
                                <button class="button button-fill button-large" onclick="saveDetectedInventory()">
                                    <img src="img/addtolist.jpg" alt="Add Detected Items">
                                </button>
                            </div>
                        </div>
                        
                        <!-- Manual Add -->
                        <div class="block-title">Add Item Manually</div>
                        <div class="list no-hairlines-md">
                            <ul>
                                <li class="item-content item-input" style="width: 50%;">
                                    <div class="item-inner">
                                        <div class="item-input-wrap">
                                            <input type="text" id="manual-item-input" style="font-weight: bold;" placeholder="Item name">
                                        </div>
                                    </div>
                                </li>
                                <li class="item-content item-input" style="width: 50%;">
                                    <div class="item-inner">
                                        <div class="item-input-wrap">
                                            <input type="date" id="manual-expiry-input" style="font-weight: bold;" placeholder="Expiry date (optional)">
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="block">
                            <button class="button button-fill" onclick="window.addManualItem()">
                                <img src="img/addtopantry.jpg" alt="Add Item">
                            </button>
                        </div>
                        
                        <!-- Inventory List -->
                        <div class="block-title">
                            Your Inventory <span id="item-count" style="color: #6b7280;">(0 items)</span>
                        </div>
                        <div id="inventory-placeholder" class="block text-align-center" style="color: #9ca3af;">
                            <i class="f7-icons" style="font-size: 64px; color: #d1d5db;">cube_box</i>
                            <p>No items in inventory</p>
                        </div>
                        <div class="list media-list" id="inventory-list-container">
                            <ul id="inventory-list"></ul>
                        </div>
                        
                        <!-- Delete Controls -->
                        <div id="delete-controls" class="block" style=" border:none; display: none;">
                            <div class="row">
                                <div class="col-50">
                                    <button onclick="window.deleteSelectedItems()">
                                        <img src="img/delete.jpg" style="height: 60px;" alt="Delete">
                                    </button>
                                </div>
                                <div class="col-50">
                                    <button class="button" onclick="window.removeAllItems()">
                                        <img src="img/removeall.jpg" alt="Clear All">
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recipes Tab -->
                    <div id="tab-recipes" class="tab page-content">
                        <div class="block-title">Recipe Search</div>
                        <div class="card">
                            <div class="card-content card-content-padding">
                                <div class="list no-hairlines-md">
                                    <ul>
                                        <li class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-input-wrap">
                                                    <input type="text" id="recipe-search-input" placeholder="Search for recipes...">
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <button class="button button-fill" onclick="searchRecipes()">
                                    <img src="img/searchforrecipe.jpg" alt="Search Recipes">
                                </button>
                            </div>
                        </div>
                        
                        <div font size="7">Generate from Inventory</div>
                        <div class="card">
                            <div class="card-content card-content-padding">
                                <div class="list no-hairlines-md">
                                    <ul>
                                        <li class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Max Cook Time</div>
                                                <div class="item-input-wrap">
                                                    <input type="number" id="max-cook-time" value="60" min="10" max="240">
                                                </div>
                                            </div>
                                        </li>
                                        <li class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Max Ingredients</div>
                                                <div class="item-input-wrap">
                                                    <input type="number" id="max-ingredients" value="10" min="3" max="20">
                                                </div>
                                            </div>
                                        </li>
                                        <li>
                                            <label class="item-checkbox item-content">
                                                <input type="checkbox" id="allow-missing-ingredients">
                                                <i class="icon icon-checkbox"></i>
                                                <div class="item-inner">
                                                    <div class="item-title">Allow missing ingredients</div>
                                                </div>
                                            </label>
                                        </li>
                                    </ul>
                                </div>
                                <div class="segmented segmented-strong">
                                    <button class="button button-active" data-unit="metric" onclick="window.toggleUnits('metric')"><img src="img/metric.jpg" alt="Metric"></button>
                                    <button class="button" data-unit="standard" onclick="window.toggleUnits('standard')"><img src="img/standard.jpg" alt="Standard"></button>
                                </div>
                                <button id="generate-recipe-btn" class="button button-fill button-large" onclick="generateRecipes()" style="margin-top: 16px;">
                                    <img src="img/generaterecipe.jpg" alt="Generate 3 Recipes">
                                </button>
                                <div id="recipe-generation-status" style="display: none; margin-top: 16px; text-align: center;">
                                    <div class="preloader"></div>
                                    <p style="margin-top: 8px; color: #6366f1;">Consulting the Smart Chef...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recipe Results -->
                        <div id="recipe-list-view" class="list media-list" style="margin-top: 16px;"></div>
                        <div id="recipe-detail-view" style="display: none;"></div>
                        
                        <!-- Saved Recipes -->
                        <div class="block-title">Saved Recipes</div>
                        <div id="saved-recipes-list" class="list media-list"></div>
                    </div>
                    
                    <!-- Schedule Tab -->
                    <div id="tab-schedule" class="tab page-content">
                        <div class="block-title">Meal Schedule</div>
                        <div id="calendar-container"></div>
                    </div>
                    
                    <!-- Shopping Tab -->
                    <div id="tab-shopping" class="tab page-content">
                        <div class="block-title">Shopping List</div>
                        <div class="list no-hairlines-md">
                            <ul>
                                <li class="item-content item-input">
                                    <div class="item-inner">
                                        <div class="item-input-wrap">
                                            <input type="text" id="shopping-item-input" placeholder="Add item...">
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="block">
                            <button class="button button-fill" onclick="addShoppingItem()">
                                <img src="img/addtolist.jpg" alt="Add Item">
                            </button>
                        </div>
                        <div id="shopping-list" class="list"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Popups and Sheets will be added here -->
    </div>

    <!-- Framework7 Library -->
    <script src="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Initialize Framework7
        const app = new Framework7({
            el: '#app',
            name: 'Meal Sense 2',
            theme: 'auto',
            colors: {
                primary: '#6366f1',
            }
        });

        // Global state
        window.currentUserId = null;
        window.inventory = [];
        window.savedRecipes = [];
        window.shoppingList = [];
        window.selectedInventoryIds = new Set();
        window.latestGeneratedRecipes = [];
        window.mealSchedule = {};
        window.units = 'metric';
        window.db = null;
        window.auth = null;
        window.functions = null;
        // window.callGemini removed (legacy Gemini callable function)
        window.latestImageBase64 = null;
        window.f7 = app;

        const appId = '1:89889306830:web:be0e6e5b707e2ba89ef89f';
        const GEMINI_VISION_MODEL = "gemini-2.0-flash-exp";
        const GEMINI_TEXT_MODEL = "gemini-2.0-flash-exp";

        const firebaseConfig = {
            apiKey: "AIzaSyCVlMsqNsW63L4m_u72Sv6WBFlw_pjUYpg",
            authDomain: "gen-lang-client-0381888356.firebaseapp.com",
            projectId: "gen-lang-client-0381888356",
            storageBucket: "gen-lang-client-0381888356.appspot.com",
            messagingSenderId: "89889306830",
            appId: "1:89889306830:web:be0e6e5b707e2ba89ef89f"
        };

        // Initialize Firebase
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(firebaseApp);
            window.auth = getAuth(firebaseApp);
            window.functions = getFunctions(firebaseApp);
            // window.callGemini assignment removed (legacy Gemini callable function)

            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.currentUserId = user.uid;
                    setupInventoryListener();
                    setupSavedRecipeListener();
                    setupShoppingListListener();
                    setupMealScheduleListener();
                } else {
                    const { user: anonUser } = await signInAnonymously(window.auth);
                    window.currentUserId = anonUser.uid;
                    setupInventoryListener();
                    setupSavedRecipeListener();
                    setupShoppingListListener();
                    setupMealScheduleListener();
                }
            });
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            app.dialog.alert('Failed to connect to Firebase: ' + e.message, 'Connection Error');
        }

        // Helper functions
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
        const normalizeItemName = (name) => name.toLowerCase().trim();

        window.mergeDuplicateItems = (items) => {
            const itemMap = new Map();
            items.forEach(item => {
                const normalizedName = normalizeItemName(item.name);
                if (itemMap.has(normalizedName)) {
                    const existing = itemMap.get(normalizedName);
                    existing.quantity = (existing.quantity || 1) + (item.quantity || 1);
                    if (item.expiry && existing.expiry) {
                        existing.expiry = new Date(item.expiry) < new Date(existing.expiry) ? item.expiry : existing.expiry;
                    } else if (item.expiry && !existing.expiry) {
                        existing.expiry = item.expiry;
                    }
                } else {
                    itemMap.set(normalizedName, {
                        id: item.id || generateId(),
                        name: item.name,
                        expiry: item.expiry || null,
                        quantity: item.quantity || 1
                    });
                }
            });
            return Array.from(itemMap.values());
        };

        function getDateDifferenceInDays(dateString) {
            if (!dateString) return Infinity;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiryDate = new Date(dateString);
            expiryDate.setHours(0, 0, 0, 0);
            const diffTime = expiryDate.getTime() - today.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function isWithinDays(dateString, days) {
            const diff = getDateDifferenceInDays(dateString);
            return diff > 0 && diff <= days;
        }

        function isExpiredToday(dateString) {
            return getDateDifferenceInDays(dateString) <= 0;
        }

        function getItemImage(name) {
            if (!name) return 'img/placeholder.svg';
            const n = name.toLowerCase();
            const map = [
                { keys: ['milk','whole milk','skim','dairy'], img: 'milk' },
                { keys: ['egg','eggs'], img: 'eggs' },
                { keys: ['cheese','cheddar','mozzarella','gouda'], img: 'cheese' },
                { keys: ['apple','apples'], img: 'apple' },
                { keys: ['banana','bananas'], img: 'banana' },
                { keys: ['bread','loaf','baguette'], img: 'bread' },
                { keys: ['chicken','drumstick','breast','thigh'], img: 'chicken' },
                { keys: ['tomato','tomatoes'], img: 'tomato' },
                { keys: ['carrot','carrots'], img: 'carrot' },
                { keys: ['potato','potatoes'], img: 'potato' },
            ];
            for (const entry of map) {
                if (entry.keys.some(k => n.includes(k))) {
                    return `img/${entry.img}.svg`;
                }
            }
            return 'img/placeholder.svg';
        }

        // Firestore listeners
        function setupInventoryListener() {
            if (!window.currentUserId || !window.db) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/pantry_inventory`;
            const inventoryDocRef = doc(window.db, docPath, "inventory_list");

            onSnapshot(inventoryDocRef, { includeMetadataChanges: true }, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let items = Array.isArray(data.items) ? data.items.map(item => ({
                        id: item.id || null,
                        name: item.name,
                        expiry: item.expiry || null,
                        quantity: item.quantity || 1
                    })) : [];

                    const needsMigration = items.some(i => !i.id);
                    if (needsMigration) {
                        items = items.map(i => ({ id: i.id || generateId(), name: i.name, expiry: i.expiry || null, quantity: i.quantity || 1 }));
                    }

                    const mergedItems = window.mergeDuplicateItems(items);
                    const hasDuplicates = mergedItems.length < items.length;

                    if (needsMigration || hasDuplicates) {
                        window.inventory = mergedItems;
                        setDoc(inventoryDocRef, { items: mergedItems }).catch(err => console.error('Migration/merge save failed:', err));
                    } else {
                        window.inventory = mergedItems;
                    }
                } else {
                    window.inventory = [];
                }
                window.renderInventory();
            });
        }

        function setupSavedRecipeListener() {
            if (!window.currentUserId || !window.db) return;
            const collectionPath = `artifacts/${appId}/users/${window.currentUserId}/saved_recipes`;
            const savedRecipesCollectionRef = collection(window.db, collectionPath);
            const savedRecipesQuery = query(savedRecipesCollectionRef);

            onSnapshot(savedRecipesQuery, (querySnapshot) => {
                window.savedRecipes = [];
                querySnapshot.forEach((doc) => {
                    window.savedRecipes.push({ id: doc.id, ...doc.data() });
                });
                window.renderSavedRecipes();
            });
        }

        function setupShoppingListListener() {
            if (!window.currentUserId || !window.db) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/shopping_list`;
            const listDocRef = doc(window.db, docPath, 'list');

            onSnapshot(listDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.shoppingList = Array.isArray(data.items) ? data.items.map(i => ({ id: i.id || null, name: i.name })) : [];
                } else {
                    window.shoppingList = [];
                }
                window.renderShoppingList();
            });
        }

        function setupMealScheduleListener() {
            if (!window.currentUserId || !window.db) return;
            const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
            const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');

            onSnapshot(scheduleDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.mealSchedule = data.schedule || {};
                } else {
                    window.mealSchedule = {};
                }
                window.renderSchedule();
            });
        }

        // Firestore CRUD
        window.appendItemsToInventory = async (itemsArray) => {
            if (!window.currentUserId || !window.db || itemsArray.length === 0) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/pantry_inventory`;
            const inventoryDocRef = doc(window.db, docPath, "inventory_list");

            try {
                const docSnap = await getDoc(inventoryDocRef);
                let currentItems = [];
                if (docSnap.exists()) {
                    currentItems = docSnap.data().items || [];
                }
                const combinedItems = [...currentItems, ...itemsArray];
                const mergedItems = window.mergeDuplicateItems(combinedItems);
                await setDoc(inventoryDocRef, { items: mergedItems });
            } catch (e) {
                if (e.code === 'not-found') {
                    const mergedItems = window.mergeDuplicateItems(itemsArray);
                    await setDoc(inventoryDocRef, { items: mergedItems });
                } else {
                    console.error("Error appending inventory items:", e);
                }
            }
        };

        window.saveInventoryToDb = async (newInventory) => {
            if (!window.currentUserId || !window.db) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/pantry_inventory`;
            const inventoryDocRef = doc(window.db, docPath, "inventory_list");
            try {
                await setDoc(inventoryDocRef, { items: newInventory });
            } catch (e) {
                console.error("Error saving inventory:", e);
            }
        };

        window.saveShoppingListToDb = async (newList) => {
            if (!window.currentUserId || !window.db) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/shopping_list`;
            const listDocRef = doc(window.db, docPath, 'list');
            try {
                await setDoc(listDocRef, { items: newList });
            } catch (e) {
                console.error('Error saving shopping list:', e);
            }
        };

        // Render functions
        window.renderInventory = () => {
            const listEl = document.getElementById('inventory-list');
            const countEl = document.getElementById('item-count');
            const placeholder = document.getElementById('inventory-placeholder');
            const deleteControls = document.getElementById('delete-controls');

            if (!listEl) return;

            const sortedInventory = window.inventory.sort((a, b) => {
                const aDays = getDateDifferenceInDays(a.expiry);
                const bDays = getDateDifferenceInDays(b.expiry);
                if (aDays !== bDays) return aDays - bDays;
                return a.name.localeCompare(b.name);
            });

            listEl.innerHTML = '';
            if (countEl) countEl.textContent = `(${window.inventory.length} items)`;
            if (placeholder) placeholder.style.display = window.inventory.length > 0 ? 'none' : 'block';
            if (deleteControls) deleteControls.style.display = window.inventory.length > 0 ? 'block' : 'none';

            sortedInventory.forEach((item) => {
                const isExpired = item.expiry && isExpiredToday(item.expiry);
                const isExpiringSoon = item.expiry && isWithinDays(item.expiry, 3);
                const selected = window.selectedInventoryIds.has(item.id);

                let expiryText = '';
                let itemClass = '';

                if (isExpired) {
                    expiryText = '<span style="color: #dc2626; font-weight: bold;">EXPIRED</span>';
                    itemClass = 'expired-item';
                } else if (isExpiringSoon) {
                    expiryText = `<span style="color: #f59e0b; font-weight: bold;">Expires in ${getDateDifferenceInDays(item.expiry)} days</span>`;
                    itemClass = 'expiring-soon-item';
                } else if (item.expiry) {
                    expiryText = `<span style="color: #10b981;">Until ${item.expiry}</span>`;
                }

                const li = document.createElement('li');
                li.className = itemClass;
                li.innerHTML = `
                    <label class="item-checkbox item-content">
                        <input type="checkbox" ${selected ? 'checked' : ''} onchange="window.toggleInventorySelection('${item.id}')">
                        <i class="icon icon-checkbox"></i>
                        <div class="item-media">
                            <div class="item-thumbnail">
                                <img src="${getItemImage(item.name)}" alt="${item.name}">
                            </div>
                        </div>
                        <div class="item-inner">
                            <div class="item-title-row">
                                <div class="item-title">${item.name}</div>
                            </div>
                            <div class="item-subtitle">${expiryText || 'No expiry set'}</div>
                            <div class="item-text" style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                <div class="quantity-controls">
                                    <a class="quantity-btn" onclick="event.preventDefault(); event.stopPropagation(); window.adjustQuantity('${item.id}', -1)">âˆ’</a>
                                    <span class="quantity-value">${item.quantity || 1}</span>
                                    <a class="quantity-btn" onclick="event.preventDefault(); event.stopPropagation(); window.adjustQuantity('${item.id}', 1)">+</a>
                                </div>
                                <a class="button button-small button-outline" onclick="event.preventDefault(); event.stopPropagation(); window.showEditItemNameModal('${item.id}')">Edit</a>
                                <a class="button button-small button-outline" onclick="event.preventDefault(); event.stopPropagation(); window.showEditExpiryModal('${item.id}', '${item.name}')">Date</a>
                            </div>
                        </div>
                    </label>
                `;
                listEl.appendChild(li);
            });

            const deleteBtn = document.getElementById('delete-selected-btn');
            if (deleteBtn) {
                deleteBtn.disabled = window.selectedInventoryIds.size === 0;
            }
        };

        window.renderSavedRecipes = () => {
            const listEl = document.getElementById('saved-recipes-list');
            if (!listEl) return;
            listEl.innerHTML = '<ul></ul>';
            const ul = listEl.querySelector('ul');
            window.savedRecipes.forEach(recipe => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="item-link item-content">
                        <div class="item-inner">
                            <div class="item-title">${recipe.title}</div>
                        </div>
                    </a>
                `;
                li.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    app.dialog.alert(recipe.content, recipe.title);
                });
                ul.appendChild(li);
            });
        };

        window.renderShoppingList = () => {
            const listEl = document.getElementById('shopping-list');
            if (!listEl) return;
            listEl.innerHTML = '<ul></ul>';
            const ul = listEl.querySelector('ul');
            window.shoppingList.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title">${item.name}</div>
                            <div class="item-after">
                                <a href="#" onclick="window.removeShoppingItem('${item.id}'); return false;" class="button button-small button-fill color-red">Remove</a>
                            </div>
                        </div>
                    </div>
                `;
                ul.appendChild(li);
            });
        };

        window.renderSchedule = () => {
            const container = document.getElementById('calendar-container');
            if (!container) return;
            container.innerHTML = '<div class="list"><ul></ul></div>';
            const ul = container.querySelector('ul');
            
            const dates = Object.keys(window.mealSchedule).sort();
            dates.forEach(date => {
                const meal = window.mealSchedule[date];
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title">${date}</div>
                            <div class="item-subtitle">${meal.recipeTitle}</div>
                        </div>
                    </div>
                `;
                ul.appendChild(li);
            });
        };

        // Inventory CRUD
        window.toggleInventorySelection = (id) => {
            if (window.selectedInventoryIds.has(id)) {
                window.selectedInventoryIds.delete(id);
            } else {
                window.selectedInventoryIds.add(id);
            }
            window.renderInventory();
        };

        window.deleteSelectedItems = () => {
            if (window.selectedInventoryIds.size === 0) return;
            const idsToRemove = Array.from(window.selectedInventoryIds);
            const newInventory = window.inventory.filter(item => !idsToRemove.includes(item.id));
            window.selectedInventoryIds.clear();
            window.saveInventoryToDb(newInventory);
        };

        window.removeAllItems = () => {
            if (window.inventory.length === 0) return;
            app.dialog.confirm('Remove all items from inventory?', 'Confirm', () => {
                window.saveInventoryToDb([]);
            });
        };

        window.addManualItem = () => {
            const inputEl = document.getElementById('manual-item-input');
            const expiryEl = document.getElementById('manual-expiry-input');
            const name = inputEl.value.trim();
            const expiry = expiryEl.value || null;

            if (name) {
                const newItem = { id: generateId(), name: name, expiry: expiry, quantity: 1 };
                window.appendItemsToInventory([newItem]);
                inputEl.value = '';
                expiryEl.value = '';
            }
        };

        window.adjustQuantity = (id, delta) => {
            const itemIndex = window.inventory.findIndex(item => item.id === id);
            if (itemIndex === -1) return;

            const newInventory = JSON.parse(JSON.stringify(window.inventory));
            const currentQty = newInventory[itemIndex].quantity || 1;
            const newQty = Math.max(1, currentQty + delta);

            newInventory[itemIndex].quantity = newQty;
            window.saveInventoryToDb(newInventory);
        };

        window.showEditItemNameModal = (id) => {
            const item = window.inventory.find(i => i.id === id);
            if (!item) return;

            app.dialog.prompt('Edit item name:', 'Edit Item', (value) => {
                if (!value.trim()) return;
                const itemIndex = window.inventory.findIndex(i => i.id === id);
                if (itemIndex >= 0) {
                    const newInventory = JSON.parse(JSON.stringify(window.inventory));
                    newInventory[itemIndex].name = value.trim();
                    window.saveInventoryToDb(newInventory);
                }
            }, () => {}, item.name);
        };

        window.showEditExpiryModal = (id, itemName) => {
            const item = window.inventory.find(i => i.id === id);
            if (!item) return;

            app.dialog.prompt('Enter expiry date (YYYY-MM-DD):', itemName, (value) => {
                const itemIndex = window.inventory.findIndex(i => i.id === id);
                if (itemIndex >= 0) {
                    const newInventory = JSON.parse(JSON.stringify(window.inventory));
                    newInventory[itemIndex].expiry = value || null;
                    window.saveInventoryToDb(newInventory);
                }
            }, () => {}, item.expiry || '');
        };

        // Scanner logic
        const imagePreviewEl = document.getElementById('scan-preview');
        const imagePlaceholderEl = document.getElementById('scan-placeholder');
        const processScanBtn = document.getElementById('process-scan-btn');
        const scanStatusEl = document.getElementById('scan-status');
        const scanStatusTextEl = document.getElementById('scan-status-text');
        const scanErrorEl = document.getElementById('scan-error');
        const detectionResultEl = document.getElementById('detection-result');
        const detectedItemsListEl = document.getElementById('detected-items-list');

        document.getElementById('camera-input').addEventListener('change', handleImageInput);
        document.getElementById('file-input').addEventListener('change', handleImageInput);

        function handleImageInput(e) {
            const file = e.target.files[0];
            if (file) {
                processScanBtn.disabled = false;
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreviewEl.src = event.target.result;
                    imagePreviewEl.style.display = 'block';
                    imagePlaceholderEl.style.display = 'none';
                    const base64String = event.target.result.split(',')[1];
                    window.latestImageBase64 = {
                        data: base64String,
                        mimeType: file.type
                    };
                };
                reader.readAsDataURL(file);
            }
            detectionResultEl.style.display = 'none';
            scanErrorEl.style.display = 'none';
        }

        processScanBtn.addEventListener('click', processImageForInventory);

        async function processImageForInventory() {
            if (!window.latestImageBase64) {
                app.dialog.alert('Please select an image first', 'Error');
                return;
            }

            scanStatusEl.style.display = 'block';
            detectionResultEl.style.display = 'none';
            scanErrorEl.style.display = 'none';
            processScanBtn.disabled = true;

            const userQuery = "Analyze the contents of this image. Identify and list all visible food, drink, and cooking ingredients. For each item, list the name and estimate quantity or size.";

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    detectedIngredients: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "name": { "type": "STRING", "description": "The name of the detected food item with quantity." },
                                "confidence": { "type": "STRING", "description": "High, Medium, or Low" }
                            },
                            required: ["name", "confidence"]
                        }
                    }
                }
            };

            const payload = {
                modelName: GEMINI_VISION_MODEL,
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: window.latestImageBase64.mimeType,
                                data: window.latestImageBase64.data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };

            try {
                // Gemini callable function usage removed; migrate to AI Logic SDK
                const responseData = result?.data?.result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (responseData) {
                    let parsedJson;
                    try {
                        const cleaned = responseData.replace(/^```json\s*/i, '').replace(/```\s*$/, '').trim();
                        parsedJson = JSON.parse(cleaned);
                    } catch (e) {
                        throw new Error("Invalid JSON structure.");
                    }

                    window.renderDetectedItems(parsedJson.detectedIngredients || []);
                } else {
                    throw new Error("Empty response from vision model.");
                }
            } catch (error) {
                scanErrorEl.textContent = 'Error: ' + error.message;
                scanErrorEl.style.display = 'block';
            }

            scanStatusEl.style.display = 'none';
            processScanBtn.disabled = false;
        }

        window.renderDetectedItems = (items) => {
            detectedItemsListEl.innerHTML = '';

            const currentNames = window.inventory.map(item => item.name.toLowerCase());
            const newItems = items.filter(item => !currentNames.includes(item.name.toLowerCase()));

            window.itemsToSave = newItems;

            if (newItems.length === 0) {
                detectionResultEl.style.display = 'none';
                return;
            }

            newItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <label class="item-checkbox item-content">
                        <input type="checkbox" checked data-name="${item.name}">
                        <i class="icon icon-checkbox"></i>
                        <div class="item-inner">
                            <div class="item-title">${item.name}</div>
                            <div class="item-after">${item.confidence}</div>
                        </div>
                    </label>
                `;
                detectedItemsListEl.appendChild(li);
            });

            detectionResultEl.style.display = 'block';
        };

        window.saveDetectedInventory = function() {
            const checkboxes = detectedItemsListEl.querySelectorAll('input[type="checkbox"]:checked');

            const itemsToAdd = Array.from(checkboxes)
                .map(cb => cb.dataset.name.trim())
                .filter(name => name.length > 0);

            if (itemsToAdd.length === 0) return;

            const newItems = itemsToAdd.map(name => ({ id: generateId(), name: name, expiry: null, quantity: 1 }));
            window.appendItemsToInventory(newItems);

            // Reset scanner
            imagePreviewEl.style.display = 'none';
            imagePlaceholderEl.style.display = 'block';
            processScanBtn.disabled = true;
            detectionResultEl.style.display = 'none';
            window.latestImageBase64 = null;

            app.toast.create({
                text: `Added ${newItems.length} items to inventory`,
                closeTimeout: 2000,
            }).open();
        };

        // Shopping list functions
        window.addShoppingItem = function() {
            const input = document.getElementById('shopping-item-input');
            const name = input.value.trim();
            if (name) {
                const newItem = { id: generateId(), name: name };
                const newList = [...window.shoppingList, newItem];
                window.saveShoppingListToDb(newList);
                input.value = '';
            }
        };

        window.removeShoppingItem = function(id) {
            const newList = window.shoppingList.filter(item => item.id !== id);
            window.saveShoppingListToDb(newList);
        };

        // Recipe functions
        window.toggleUnits = function(unit) {
            window.units = unit;
            const buttons = document.querySelectorAll('[data-unit]');
            buttons.forEach(btn => {
                if (btn.dataset.unit === unit) {
                    btn.classList.add('button-active');
                } else {
                    btn.classList.remove('button-active');
                }
            });
        };

        const formatRecipeContent = (recipe) => {
            const content = `
Recipe Name: ${recipe.recipeName}

--- INGREDIENTS ---
${recipe.ingredientsSummary}

--- INSTRUCTIONS ---
${recipe.instructions}

${recipe.missingIngredients && recipe.missingIngredients.length > 0 ? '\n--- MISSING INGREDIENTS ---\n' + recipe.missingIngredients.join('\n') : ''}
`;
            return content.trim();
        };

        window.generateRecipes = async function() {
            if (window.inventory.length === 0) {
                app.dialog.alert('Your pantry is empty! Please add items first.', 'Error');
                return;
            }

            const statusEl = document.getElementById('recipe-generation-status');
            const listEl = document.getElementById('recipe-list-view');
            statusEl.style.display = 'block';
            listEl.innerHTML = '';

            const maxCookTime = document.getElementById('max-cook-time').value;
            const maxIngredients = document.getElementById('max-ingredients').value;
            const allowMissingIngredients = document.getElementById('allow-missing-ingredients').checked;

            const inventoryList = window.inventory.map(item => {
                let s = item.name;
                if (item.quantity > 1) s += ` (x${item.quantity})`;
                if (item.expiry) s += ` (Expires ${item.expiry})`;
                return s;
            }).join(', ');

            const unitPreference = window.units === 'metric' ?
                'Use Metric measurements (grams, milliliters, Celsius)' :
                'Use Standard US measurements (ounces, cups, Fahrenheit)';

            let systemPrompt = `You are a world-class chef. ${unitPreference}. Cooking time under ${maxCookTime} minutes. Max ${maxIngredients} ingredients. `;

            if (allowMissingIngredients) {
                systemPrompt += `Generate 3 recipes using available inventory, but you may include common missing ingredients. Mark which are AVAILABLE vs MISSING.`;
            } else {
                systemPrompt += `Generate 3 recipes using ONLY the ingredients from inventory.`;
            }

            const userQuery = `My pantry: ${inventoryList}. Generate 3 recipes.`;

            const recipeSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "recipeName": { "type": "STRING" },
                        "ingredientsSummary": { "type": "STRING" },
                        "instructions": { "type": "STRING" },
                        "deductibleInventoryStrings": { 
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        },
                        "missingIngredients": {
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        }
                    },
                    required: ["recipeName", "ingredientsSummary", "instructions", "deductibleInventoryStrings"]
                }
            };

            const payload = {
                modelName: GEMINI_TEXT_MODEL,
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: recipeSchema
                }
            };

            try {
                // Gemini callable function usage removed; migrate to AI Logic SDK
                const responseData = result?.data?.result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (responseData) {
                    let parsedJson;
                    try {
                        const cleaned = responseData.replace(/^```json\s*/i, '').replace(/```\s*$/, '').trim();
                        parsedJson = JSON.parse(cleaned);
                    } catch (e) {
                        throw new Error("Invalid JSON from AI.");
                    }

                    window.latestGeneratedRecipes = parsedJson;
                    renderGeneratedRecipesList();
                } else {
                    throw new Error("Empty response from AI.");
                }
            } catch (error) {
                app.dialog.alert('Recipe generation failed: ' + error.message, 'Error');
            }

            statusEl.style.display = 'none';
        };

        function renderGeneratedRecipesList() {
            const listEl = document.getElementById('recipe-list-view');
            listEl.innerHTML = '<ul></ul>';
            const ul = listEl.querySelector('ul');

            window.latestGeneratedRecipes.forEach((recipe, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" class="item-link item-content">
                        <div class="item-inner">
                            <div class="item-title">${recipe.recipeName}</div>
                        </div>
                    </a>
                `;
                li.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    viewGeneratedRecipe(index);
                });
                ul.appendChild(li);
            });
        }

        function viewGeneratedRecipe(index) {
            const recipe = window.latestGeneratedRecipes[index];
            if (!recipe) return;

            window.selectedGeneratedRecipeIndex = index;
            const content = formatRecipeContent(recipe);

            const sheet = app.sheet.create({
                content: `
                    <div class="sheet-modal">
                        <div class="toolbar">
                            <div class="toolbar-inner">
                                <div class="left"></div>
                                <div class="right">
                                    <a class="link sheet-close">Close</a>
                                </div>
                            </div>
                        </div>
                        <div class="sheet-modal-inner">
                            <div class="page-content">
                                <div class="block-title">${recipe.recipeName}</div>
                                <div class="block">
                                    <pre style="white-space: pre-wrap; font-family: inherit; font-size: 14px;">${content}</pre>
                                </div>
                                <div class="block">
                                    <button class="button button-fill color-green" onclick="window.saveCurrentRecipe()">Save Recipe</button>
                                    <button class="button button-fill" onclick="window.scheduleRecipeModal()">Schedule</button>
                                    <button class="button button-fill color-orange" onclick="window.deductInventory()">Mark as Made</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                swipeToClose: true,
            });
            sheet.open();
        }

        window.saveCurrentRecipe = async function() {
            if (window.selectedGeneratedRecipeIndex === null) return;
            const recipe = window.latestGeneratedRecipes[window.selectedGeneratedRecipeIndex];
            if (!recipe) return;

            const content = formatRecipeContent(recipe);
            await window.saveGeneratedRecipeToDb(recipe.recipeName, content);
            app.toast.create({
                text: 'Recipe saved!',
                closeTimeout: 2000,
            }).open();
        };

        window.saveGeneratedRecipeToDb = async (title, content) => {
            if (!window.currentUserId || !window.db) return false;
            const collectionPath = `artifacts/${appId}/users/${window.currentUserId}/saved_recipes`;
            const recipesCollectionRef = collection(window.db, collectionPath);
            try {
                await addDoc(recipesCollectionRef, {
                    title: title,
                    content: content,
                    createdAt: new Date().toISOString()
                });
                return true;
            } catch (e) {
                console.error("Error saving recipe:", e);
                return false;
            }
        };

        window.deductInventory = function() {
            if (window.selectedGeneratedRecipeIndex === null) return;
            const recipe = window.latestGeneratedRecipes[window.selectedGeneratedRecipeIndex];

            if (!recipe || !Array.isArray(recipe.deductibleInventoryStrings)) return;

            const itemsToDeduct = recipe.deductibleInventoryStrings.map(s => normalizeItemName(s));

            if (itemsToDeduct.length === 0) {
                app.dialog.alert('No items to deduct', 'Info');
                return;
            }

            let newInventory = JSON.parse(JSON.stringify(window.inventory));

            itemsToDeduct.forEach(deductName => {
                const index = newInventory.findIndex(item => normalizeItemName(item.name) === deductName);
                if (index !== -1) {
                    if (newInventory[index].quantity > 1) {
                        newInventory[index].quantity -= 1;
                    } else {
                        newInventory.splice(index, 1);
                    }
                }
            });

            window.saveInventoryToDb(newInventory);
            app.toast.create({
                text: 'Inventory updated!',
                closeTimeout: 2000,
            }).open();
        };

        window.scheduleRecipeModal = function() {
            if (window.selectedGeneratedRecipeIndex === null) return;
            const recipe = window.latestGeneratedRecipes[window.selectedGeneratedRecipeIndex];
            if (!recipe) return;

            app.dialog.prompt('Enter date (YYYY-MM-DD):', 'Schedule Recipe', async (date) => {
                if (!date) return;
                await scheduleRecipe(recipe.recipeName, formatRecipeContent(recipe), date);
                app.toast.create({
                    text: 'Recipe scheduled!',
                    closeTimeout: 2000,
                }).open();
            });
        };

        async function scheduleRecipe(title, content, date) {
            if (!window.currentUserId || !window.db) return;
            const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
            const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');

            try {
                const docSnap = await getDoc(scheduleDocRef);
                let currentSchedule = {};
                if (docSnap.exists()) {
                    currentSchedule = docSnap.data().schedule || {};
                }

                currentSchedule[date] = {
                    recipeTitle: title,
                    recipeContent: content
                };

                await setDoc(scheduleDocRef, { schedule: currentSchedule });
            } catch (e) {
                console.error("Error scheduling recipe:", e);
            }
        }

        window.searchRecipes = function() {
            app.dialog.alert('Recipe search feature coming soon!', 'Feature');
        };

    </script>
</body>
</html>
