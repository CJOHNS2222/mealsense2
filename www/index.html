<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Meal Sense 2</title>
    
    <!-- Framework7 CSS -->
     <style lang="css">
        @import '/mealsense2/framework.css';
    </style>
    <style>
        :root {
            --f7-theme-color: #44130e;
            --f7-theme-color-rgb: 99, 102, 241;
            --f7-theme-color-shade: #44130e;
            --f7-theme-color-tint: #44130e;
            --f7-safe-area-left: 0px;
            --f7-safe-area-right: 0px;
            /* App background color (tuned to image red) */
            --app-bg-color: #44130e;
        }
        
        /* Add top padding for header image to avoid notification bar */
        .tab-banner {
            padding-top: env(safe-area-inset-top, 24px);
            background: #44130e;
        }
        
        /* Center shopping list text on store tab */
        #tab-shopping .block-title {
            text-align: center !important;
        }
        
        /* Bold saved recipes and style remove as button */
        #saved-recipes-list .item-title {
            font-weight: bold !important;
        }
        #saved-recipes-list .remove-recipe-btn {
            display: inline-block;
            background: #ef4444;
            color: #fff !important;
            border: none;
            border-radius: 6px;
            padding: 6px 14px;
            font-weight: bold;
            font-size: 15px;
            margin-left: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #saved-recipes-list .remove-recipe-btn:hover {
            background: #b91c1c;
        }
        
        .item-thumbnail {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0px solid #44130e;
            background: #44130e;
            border-radius: 0px;
        }
        
        .item-thumbnail img {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border: 0px solid #44130e;
            background: #44130e;
            border-radius: 0px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .quantity-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: #374151;
            border: 0px solid #44130e;
            background: #44130e;
            border-radius: 0px;
        }
        .quantity-btn img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            display: block;
            border: 0px none #44130e;
            background: #44130e;
            border-radius: 0px;
        }
        
        .button img {
            height: 20px;
            width: auto;
            object-fit: contain;
            vertical-align: middle;
            border: none;
        }
        
        .button-small img {
            height: 100%;
            width: 100%;
            object-fit: cover;
            border: none;
        }
        
        .button-large img {
            height: 100%;
            width: 100%;
            object-fit: cover;
            vertical-align: middle;
            border: none;
        }
        
        .button-outline {
            border: 0px solid currentColor;
        }
        
        .button-outline img {
            border: none !important;
        }
        
        .button-fill {
            border: none;
        }
        
        .button-fill img {
            border: none !important;
        }
        
        label.button img {
            border: none !important;
        }
        
        .quantity-value {
            min-width: 24px;
            text-align: center;
            font-weight: 600;
        }
        
        .expired-item {
            background: #fee2e2 !important;
        }
        
        .expiring-soon-item {
            background: #fef3c7 !important;
        }
        
        .scan-preview-box {
            width: 100%;
            height: 200px;
            border: 2px dashed #44130e;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #808080;
        }
        
        .scan-preview-img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 0px;
        }
        
        /* Hide Framework7 dialog elements that might appear incorrectly */
        .dialog:not(.modal-in) {
            display: none !important;
        }
        
        .dialog-backdrop:not(.backdrop-in) {
            display: none !important;
        }

        /* Apply red background across main containers */
        body,
        .view,
        .page,
        .page-content {
            background-color: #44130e !important;
            color: #9ca3af !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            margin: 0 !important;
        }
        /* Override all Framework7 buttons background */
        .button,
        .button.button-fill {
            background-color: #44130e !important;
        }
        /* Specific generate recipe button background */
        #generate-recipe-btn {
            background-color: #44130e !important;
        }
        
        /* Hide preloader circles */
        .preloader,
        .preloader svg,
        .preloader circle {
            display: none !important;
        }
        
        /* Sheet modal fixes */
        .sheet-modal {
            z-index: 10000 !important;
        }
        
        .sheet-modal-inner {
            overflow-y: auto !important;
            padding-bottom: 30px !important;
        }
        
        /* Tab visibility */
        .tab {
            display: none;
        }
        
        .tab.tab-active {
            display: block;
        }
    </style>
        
        </head>
<body>
    <div id="app" class="framework7-root">
        <!-- Main View -->
        <div class="view view-main view-init safe-areas" data-master-detail-breakpoint="768">
            <!-- Top Navbar -->
            <div class="navbar" style="display: none;">
                <div style="background-color: #44130e;"></div>
                <div class="navbar-inner" style="background-color: #44130e;">
                    <div class="title">Smart Pantry Chef</div>
                </div>
            </div>
            
            <!-- Toolbar/Tabs -->
            <div class="toolbar toolbar-bottom tabbar" style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; height: 123px; padding: 0 30px 40px 30px; box-sizing: border-box; background-color: #44130e;">
                <div class="toolbar-inner" style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 0; gap: 20px;">
                    <a href="#tab-inventory" class="tab-link tab-link-active" style="padding-left: 20px;">
                        <i class="icon" style="width: 138px; height: 62px;"><img src="img/inventory.jpg" alt="Inventory" style="width: 100%; height: 83px;"></i>
                    </a>
                    <a href="#tab-recipes" class="tab-link">
                        <i class="icon" style="width: 138px; height: 62px;"><img src="img/recipes.jpg" alt="Recipes" style="width: 100%; height: 83px;"></i>
                    </a>
                    <a href="#tab-schedule" class="tab-link">
                        <i class="icon" style="width: 138px; height: 62px;"><img src="img/schedule.jpg" alt="Schedule" style="width: 100%; height: 83px;"></i>
                    </a>
                    <a href="#tab-shopping" class="tab-link" style="padding-right: 20px;">
                        <i class="icon" style="width: 138px; height: 62px;"><img src="img/shopping.jpg" alt="Shopping" style="width: 100%; height: 83px;"></i>
                    </a>
                <span class="tab-link-highlight ai-style-change-1" style="width: 25%; transform: translate3d(0%, 0px, 0px);"></span></div>
            </div>
            
            <!-- Page content with tabs -->
            <div class="page page-current" style="overflow-y: auto; height: calc(100vh - 123px);">
                <div class="page-content" style="padding-top: env(safe-area-inset-top, 20px); padding-bottom: 20px; overflow-x: hidden;">
                    <div class="tabs">
                        <!-- Inventory Tab -->
                        <div id="tab-inventory" class="tab tab-active">
                        <img src="img/banner.jpg" alt="Banner" class="tab-banner" data-tab="inventory" style="position: fixed; top: 0; left: 0; right: 0; width: 100%; height: 75px; object-fit: fill; display: block; z-index: 9998;">
                        <div style="height: 75px;"></div>
                        <!-- Scanner Section -->
                        <div class="card" style="color: #44130e;">
                            <div class="card-content card-content-padding">
                                <div id="scan-preview-container" style="color: #44130e;" class="scan-preview-box">
                                    <div id="scan-placeholder">
                                        <i class="f7-icons" style="font-size: 48px; color: #9ca3af;">camera</i>
                                        <p style="color: #9ca3af; font-weight: bold; margin-top: 8px;">No image selected</p>
                                    </div>
                                    <img id="scan-preview" class="scan-preview-img" style="display: none;">
                                </div>
                                <div style="color: #44130e; text-align: center; margin-top: 20px;">
                                    <label style="cursor: pointer; display: inline-block;">
                                        <img src="img/scanimage.jpg" style="vertical-align: middle; height: 50px;" alt="Camera Capture">
                                        <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
                                    </label>
                                    <label class="button[disabled]" style="cursor: pointer; display: inline-block;">
                                        <img src="img/photogallery.jpg" style="vertical-align: middle; height: 50px;" alt="Gallery">
                                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                                    </label>
                                    <button onclick="window.processImageForInventory()" style="cursor: pointer; display: inline-block; background: #44130e; border: none;">
                                        <img src="img/analyze.jpg" style="vertical-align: middle; height: 50px;" alt="Scan Image">
                                    </button>
                                </div>
                                <div id="scan-status" class="text-align-center" style="display: none; margin-top: 16px;">
                                    <div class="preloader"><span class="preloader-inner">
    <svg viewBox="0 0 36 36">
      <circle cx="18" cy="18" r="16"></circle>
    </svg>
  </span></div>
                                    <p id="scan-status-text" style="margin-top: 8px; color: #6366f1;">Analyzing...</p>
                                </div>
                                <div id="scan-error" class="block-footer" style="display: none; color: #ef4444; margin-top: 12px;"></div>
                            </div>
                        </div>
                        
                        <!-- Detection Results -->
                        <div id="detection-result" style="display: none;">
                            <div class="block-title">Detected Items</div>
                            <div class="list">
                                <ul id="detected-items-list"></ul>
                            </div>
                            <div class="block">
                                <button class="button button-fill button-large" onclick="saveDetectedInventory()">
                                    <img src="img/addtolist.jpg" alt="Add Detected Items">
                                </button>
                            </div>
                        </div>
                        
                        <!-- Manual Add -->
                        <div class="block-title" style="margin-top: 32px; font-size: 20px; font-weight: bold; text-align: center;">Add Item Manually</div>
                        <div class="block" style="padding: 0 16px;">
                            <div style="display: flex; gap: 8px; width: 100%;">
                                <input type="text" id="manual-item-input" style="font-weight: bold; width: 50%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Item name">
                                <input type="date" id="manual-expiry-input" style="font-weight: bold; width: 50%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Expiration Date">
                            </div>
                        </div>
                        <div class="block" style="text-align: center;">
                            <button class="button button-fill" onclick="window.addManualItem()">
                                <img src="img/addtopantry.jpg" style="height: 50px;" alt="Add Item">
                            </button>
                        </div>
                        
                        <!-- Inventory List -->
                        <div class="block-title" style="font-size: 24px; font-weight: bold; margin-top: 32px; text-align: center;">
                            Your Inventory <span id="item-count" style="color: #6b7280;">(0 items)</span>
                        </div>
                        <div id="inventory-placeholder" class="block text-align-center" style="color: rgb(156, 163, 175); display: block;">
                            <i class="f7-icons" style="font-size: 64px; color: #d1d5db;">cube_box</i>
                            <p>No items in inventory</p>
                        </div>
                        <div class="list media-list" id="inventory-list-container" style="margin: 0;">
                            <ul id="inventory-list" style="margin: 0; padding: 0;"></ul>
                        </div>
                        
                        <!-- Delete Controls -->
                        <div id="delete-controls" class="block" style="border:none; display: none; text-align: center;">
                            <button onclick="window.deleteSelectedItems()" style="display: inline-block; background: #44130e; border: 0px solid transparent; vertical-align: middle;">
                                <img src="img/delete.jpg" style="height: 60px;" alt="Delete">
                            </button>
                            <button class="button" onclick="window.removeAllItems()" style="display: inline-block; background: #44130e; border: 0px solid transparent; vertical-align: middle;">
                                <img src="img/removeall.jpg" style="height: 60px;" alt="Clear All">
                            </button>
                        </div>
                    </div>
                    
                    <!-- Recipes Tab -->
                    <div id="tab-recipes" class="tab">
                        <img src="img/banner.jpg" alt="Banner" class="tab-banner" data-tab="recipes" style="position: fixed; top: 0; left: 0; right: 0; width: 100%; height: 75px; object-fit: fill; display: none; z-index: 9998;">
                        <div style="height: 75px;"></div>
                        <div class="block-title" style="font-size: 24px; font-weight: bold; text-align: center;">Recipe Search</div>
                        <div class="card" style="border: 2px solid #44130e; margin: 8px;">
                            <div class="card-content card-content-padding">
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="text" id="recipe-search-input" placeholder="Search for recipes..." style="flex: 1; font-size: 16px; font-weight: bold; padding: 12px; border: 1px solid #ccc; border-radius: 4px;">
                                    <button class="button button-fill" onclick="window.searchRecipes()" style="height: 50px; flex-shrink: 0;">
                                        <img src="img/searchforrecipe.jpg" alt="Search" style="height: 40px;">
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Generate Recipes Button (centered, always visible) -->
                        <div style="width: 100%; display: flex; justify-content: center; align-items: center; margin: 24px 0 8px 0;">
                            <button id="generate-recipe-btn" class="button button-fill button-large" onclick="window.generateRecipes()" style="height: 60px; min-width: 220px; max-width: 90vw; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; background: #6366f1; color: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <img src="img/generaterecipe.jpg" alt="Generate 3 Recipes" style="height: 50px; margin-right: 12px;">Generate Recipes
                            </button>
                        </div>

                        <!-- Recipe Generation Options (collapsible/optional) -->
                        <div class="card" style="border: 2px solid #44130e; margin: 8px;">
                            <div class="card-content card-content-padding">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                    <div>
                                        <label style="font-size: 16px; font-weight: bold; display: block; margin-bottom: 4px;">Max Cook Time</label>
                                        <input type="number" id="max-cook-time" value="60" min="10" max="240" style="width: calc(100% - 30px); font-size: 16px; font-weight: bold; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 16px; font-weight: bold; display: block; margin-bottom: 4px;">Max Ingredients</label>
                                        <input type="number" id="max-ingredients" value="10" min="3" max="20" style="width: calc(100% - 30px); font-size: 16px; font-weight: bold; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 16px; font-weight: bold; display: block; margin-bottom: 4px;">Dietary Restrictions</label>
                                        <input type="text" id="dietary-restrictions" placeholder="e.g., vegetarian" style="width: 100%; font-size: 16px; font-weight: bold; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: bold;">
                                        <input type="checkbox" id="allow-missing-ingredients">
                                        <span>Allow missing ingredients</span>
                                    </label>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="button button-active" data-unit="metric" onclick="window.toggleUnits('metric')" style="height: 50px; border: 0px solid transparent;"><img src="img/metric.jpg" alt="Metric" style="height: 40px;"></button>
                                        <button class="button" data-unit="standard" onclick="window.toggleUnits('standard')" style="height: 50px; border: 0px solid transparent;"><img src="img/standard.jpg" alt="Standard" style="height: 40px;"></button>
                                    </div>
                                </div>
                                <div id="recipe-generation-status" style="display: none; margin-top: 16px; text-align: center;">
                                    <div class="preloader"><span class="preloader-inner">
    <svg viewBox="0 0 36 36">
      <circle cx="18" cy="18" r="16"></circle>
    </svg>
  </span></div>
                                    <p style="margin-top: 8px; color: #6366f1;">Consulting the Smart Chef...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Recipe Results -->
                        <div id="recipe-list-view" class="list media-list" style="margin-top: 16px;"></div>
                        <div id="recipe-detail-view" style="display: none;"></div>

                        <!-- Saved Recipes -->
                        <div class="block-title" style="font-size: 24px; font-weight: bold; text-align: center; margin-top: 16px;">Saved Recipes</div>
                        <div id="saved-recipes-list" class="list media-list"><ul></ul></div>
                    </div>
                    
                    <!-- Schedule Tab -->
                    <div id="tab-schedule" class="tab">
                        <img src="img/banner.jpg" alt="Banner" class="tab-banner" data-tab="schedule" style="position: fixed; top: 0; left: 0; right: 0; width: 100%; height: 75px; object-fit: fill; display: none; z-index: 9998;">
                        <div style="height: 75px;"></div>
                        <div class="block-title" style="font-size: 24px; font-weight: bold; text-align: center;">Meal Schedule</div>
                        <div style="text-align: center; margin: 8px 16px;">
                            <button class="button" onclick="window.addMissingIngredientsToShopping()" style="background: #f3f4f6; color: #2563eb; font-size: 18px; font-weight: bold; padding: 14px 28px; border-radius: 8px; border: 2px solid #2563eb; box-shadow: 0 2px 4px rgba(0,0,0,0.08); margin: 0 auto; display: inline-block;">
                                Add Missing Ingredients to Shopping List
                            </button>
                        </div>
                        <div id="calendar-container" style="padding: 16px; max-width: 600px; margin: 0 auto;"></div>
                    </div>
                    
                    <!-- Shopping Tab -->
                    <div id="tab-shopping" class="tab">
                        <img src="img/banner.jpg" alt="Banner" class="tab-banner" data-tab="shopping" style="position: fixed; top: 0; left: 0; right: 0; width: 100%; height: 75px; object-fit: fill; display: none; z-index: 9998;">
                        <div style="height: 75px;"></div>
                        <div class="block-title" style="font-size: 24px; font-weight: bold;">Shopping List</div>
                        <div style="display: flex; gap: 8px; align-items: center; padding: 8px;">
                            <input type="text" id="shopping-item-input" placeholder="Add item..." onkeypress="if(event.key === 'Enter') window.addShoppingItem()" style="flex: 1; font-size: 18px; font-weight: bold; padding: 12px; border: 1px solid #ccc; border-radius: 4px;">
                            <button class="button button-fill" onclick="if(window.addShoppingItem) window.addShoppingItem(); else console.error('addShoppingItem not ready');" style="height: 50px; flex-shrink: 0;">
                                <img src="img/addtolist.jpg" alt="Add Item" style="height: 40px;">
                            </button>
                        </div>
                        <div id="shopping-list" class="list" style="padding-left: 0;"><ul style="padding-left: 0;"></ul></div>
                    </div>
                </div>
                </div>
            </div>
        </div>
        
        <!-- Popups and Sheets will be added here -->
    </div>

    <!-- Framework7 Library -->
    <script src="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Make Firebase functions globally accessible
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;

        // Initialize Framework7
        const app = new Framework7({
            el: '#app',
            name: 'Meal Sense 2',
            theme: 'auto',
            colors: {
                primary: '#6366f1',
            }
        });

        // Global state
        window.currentUserId = null;
        window.inventory = [];
        window.savedRecipes = [];
        window.shoppingList = [];
        window.selectedInventoryIds = new Set();
        window.latestGeneratedRecipes = [];
        window.mealSchedule = {};
        window.units = 'metric';
        window.db = null;
        window.auth = null;
        window.functions = null;
        window.callGemini = null;
        window.latestImageBase64 = null;
        window.f7 = app;
        window.app = app; // Make app globally accessible
        window.currentRecipePopup = null; // Track current open recipe popup

        const appId = '1:89889306830:web:be0e6e5b707e2ba89ef89f';
        const GEMINI_VISION_MODEL = "gemini-2.0-flash-exp";
        const GEMINI_TEXT_MODEL = "gemini-2.0-flash-exp";
        
        // Close recipe popups when switching tabs
        document.addEventListener('DOMContentLoaded', () => {
            const tabLinks = document.querySelectorAll('.tab-link');
            tabLinks.forEach(link => {
                link.addEventListener('click', () => {
                    // Close any open recipe popup when switching tabs
                    if (window.currentRecipePopup) {
                        window.currentRecipePopup.close();
                        window.currentRecipePopup = null;
                    }
                    
                    // Show/hide appropriate banner
                    const targetTab = link.getAttribute('href').replace('#tab-', '');
                    document.querySelectorAll('.tab-banner').forEach(banner => {
                        if (banner.dataset.tab === targetTab) {
                            banner.style.display = 'block';
                        } else {
                            banner.style.display = 'none';
                        }
                    });
                });
            });
        });

        const firebaseConfig = {
            apiKey: "AIzaSyCVlMsqNsW63L4m_u72Sv6WBFlw_pjUYpg",
            authDomain: "gen-lang-client-0381888356.firebaseapp.com",
            projectId: "gen-lang-client-0381888356",
            storageBucket: "gen-lang-client-0381888356.appspot.com",
            messagingSenderId: "89889306830",
            appId: "1:89889306830:web:be0e6e5b707e2ba89ef89f"
        };

        // Initialize Firebase
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(firebaseApp);
            window.auth = getAuth(firebaseApp);
            window.functions = getFunctions(firebaseApp);
            window.callGemini = httpsCallable(window.functions, 'callGemini');

            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.currentUserId = user.uid;
                    setupInventoryListener();
                    setupSavedRecipeListener();
                    setupShoppingListListener();
                    setupMealScheduleListener();
                } else {
                    const { user: anonUser } = await signInAnonymously(window.auth);
                    window.currentUserId = anonUser.uid;
                    setupInventoryListener();
                    setupSavedRecipeListener();
                    setupShoppingListListener();
                    setupMealScheduleListener();
                }
            });
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            app.dialog.alert('Failed to connect to Firebase: ' + e.message, 'Connection Error');
        }

        // Helper functions
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
        const normalizeItemName = (name) => name.toLowerCase().trim();

        window.mergeDuplicateItems = (items) => {
            const itemMap = new Map();
            items.forEach(item => {
                const normalizedName = normalizeItemName(item.name);
                if (itemMap.has(normalizedName)) {
                    const existing = itemMap.get(normalizedName);
                    existing.quantity = (existing.quantity || 1) + (item.quantity || 1);
                    if (item.expiry && existing.expiry) {
                        existing.expiry = new Date(item.expiry) < new Date(existing.expiry) ? item.expiry : existing.expiry;
                    } else if (item.expiry && !existing.expiry) {
                        existing.expiry = item.expiry;
                    }
                } else {
                    itemMap.set(normalizedName, {
                        id: item.id || generateId(),
                        name: item.name,
                        expiry: item.expiry || null,
                        quantity: item.quantity || 1
                    });
                }
            });
            return Array.from(itemMap.values());
        };

        function getDateDifferenceInDays(dateString) {
            if (!dateString) return Infinity;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiryDate = new Date(dateString);
            expiryDate.setHours(0, 0, 0, 0);
            const diffTime = expiryDate.getTime() - today.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function isWithinDays(dateString, days) {
            const diff = getDateDifferenceInDays(dateString);
            return diff > 0 && diff <= days;
        }

        function isExpiredToday(dateString) {
            return getDateDifferenceInDays(dateString) <= 0;
        }

        function getItemImage(name) {
            if (!name) return 'img/placeholder.svg';
            const n = name.toLowerCase();
            const map = [
                { keys: ['milk','whole milk','skim','dairy'], img: 'milk' },
                { keys: ['egg','eggs'], img: 'eggs' },
                { keys: ['cheese','cheddar','mozzarella','gouda'], img: 'cheese' },
                { keys: ['apple','apples'], img: 'apple' },
                { keys: ['banana','bananas'], img: 'banana' },
                { keys: ['bread','loaf','baguette'], img: 'bread' },
                { keys: ['chicken','drumstick','breast','thigh'], img: 'chicken' },
                { keys: ['tomato','tomatoes'], img: 'tomato' },
                { keys: ['carrot','carrots'], img: 'carrot' },
                { keys: ['potato','potatoes'], img: 'potato' },
            ];
            for (const entry of map) {
                if (entry.keys.some(k => n.includes(k))) {
                    return `img/${entry.img}.svg`;
                }
            }
            return 'img/placeholder.svg';
        }

        // Firestore listeners
        function setupInventoryListener() {
            if (!window.currentUserId || !window.db) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/pantry_inventory`;
            const inventoryDocRef = doc(window.db, docPath, "inventory_list");

            onSnapshot(inventoryDocRef, { includeMetadataChanges: true }, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let items = Array.isArray(data.items) ? data.items.map(item => ({
                        id: item.id || null,
                        name: item.name,
                        expiry: item.expiry || null,
                        quantity: item.quantity || 1
                    })) : [];

                    const needsMigration = items.some(i => !i.id);
                    if (needsMigration) {
                        items = items.map(i => ({ id: i.id || generateId(), name: i.name, expiry: i.expiry || null, quantity: i.quantity || 1 }));
                    }

                    const mergedItems = window.mergeDuplicateItems(items);
                    const hasDuplicates = mergedItems.length < items.length;

                    if (needsMigration || hasDuplicates) {
                        window.inventory = mergedItems;
                        setDoc(inventoryDocRef, { items: mergedItems }).catch(err => console.error('Migration/merge save failed:', err));
                    } else {
                        window.inventory = mergedItems;
                    }
                } else {
                    window.inventory = [];
                }
                window.renderInventory();
            });
        }

        function setupSavedRecipeListener() {
            if (!window.currentUserId || !window.db) return;
            const collectionPath = `artifacts/${appId}/users/${window.currentUserId}/saved_recipes`;
            const savedRecipesCollectionRef = collection(window.db, collectionPath);
            const savedRecipesQuery = query(savedRecipesCollectionRef);

            onSnapshot(savedRecipesQuery, (querySnapshot) => {
                window.savedRecipes = [];
                querySnapshot.forEach((doc) => {
                    window.savedRecipes.push({ id: doc.id, ...doc.data() });
                });
                window.renderSavedRecipes();
            });
        }

        function setupShoppingListListener() {
            if (!window.currentUserId || !window.db) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/shopping_list`;
            const listDocRef = doc(window.db, docPath, 'list');

            onSnapshot(listDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.shoppingList = Array.isArray(data.items) ? data.items.map(i => ({ id: i.id || null, name: i.name })) : [];
                } else {
                    window.shoppingList = [];
                }
                window.renderShoppingList();
            });
        }

        function setupMealScheduleListener() {
            if (!window.currentUserId || !window.db) return;
            const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
            const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');

            onSnapshot(scheduleDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.mealSchedule = data.schedule || {};
                } else {
                    window.mealSchedule = {};
                }
                window.renderSchedule();
            });
        }

        // Firestore CRUD
        window.appendItemsToInventory = async (itemsArray) => {
            if (!window.currentUserId || !window.db || itemsArray.length === 0) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/pantry_inventory`;
            const inventoryDocRef = doc(window.db, docPath, "inventory_list");

            try {
                const docSnap = await getDoc(inventoryDocRef);
                let currentItems = [];
                if (docSnap.exists()) {
                    currentItems = docSnap.data().items || [];
                }
                const combinedItems = [...currentItems, ...itemsArray];
                const mergedItems = window.mergeDuplicateItems(combinedItems);
                await setDoc(inventoryDocRef, { items: mergedItems });
            } catch (e) {
                if (e.code === 'not-found') {
                    const mergedItems = window.mergeDuplicateItems(itemsArray);
                    await setDoc(inventoryDocRef, { items: mergedItems });
                } else {
                    console.error("Error appending inventory items:", e);
                }
            }
        };

        window.saveInventoryToDb = async (newInventory) => {
            if (!window.currentUserId || !window.db) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/pantry_inventory`;
            const inventoryDocRef = doc(window.db, docPath, "inventory_list");
            try {
                await setDoc(inventoryDocRef, { items: newInventory });
            } catch (e) {
                console.error("Error saving inventory:", e);
            }
        };

        window.saveShoppingListToDb = async (newList) => {
            if (!window.currentUserId || !window.db) return;
            const docPath = `artifacts/${appId}/users/${window.currentUserId}/shopping_list`;
            const listDocRef = doc(window.db, docPath, 'list');
            try {
                await setDoc(listDocRef, { items: newList });
            } catch (e) {
                console.error('Error saving shopping list:', e);
            }
        };

        // Render functions
        window.renderInventory = () => {
            const listEl = document.getElementById('inventory-list');
            const countEl = document.getElementById('item-count');
            const placeholder = document.getElementById('inventory-placeholder');
            const deleteControls = document.getElementById('delete-controls');

            if (!listEl) return;

            const sortedInventory = window.inventory.sort((a, b) => {
                const aDays = getDateDifferenceInDays(a.expiry);
                const bDays = getDateDifferenceInDays(b.expiry);
                if (aDays !== bDays) return aDays - bDays;
                return a.name.localeCompare(b.name);
            });

            listEl.innerHTML = '';
            if (countEl) countEl.textContent = `(${window.inventory.length} items)`;
            if (placeholder) placeholder.style.display = window.inventory.length > 0 ? 'none' : 'block';
            if (deleteControls) deleteControls.style.display = window.inventory.length > 0 ? 'block' : 'none';

            // Create a grid container
            const gridContainer = document.createElement('div');
            gridContainer.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 0; padding: 0;';

            sortedInventory.forEach((item, index) => {
                const isExpired = item.expiry && isExpiredToday(item.expiry);
                const isExpiringSoon = item.expiry && isWithinDays(item.expiry, 3);
                const selected = window.selectedInventoryIds.has(item.id);

                let expiryText = '';
                let itemBgColor = '';

                if (isExpired) {
                    expiryText = '<span style="color: #dc2626; font-weight: bold;">EXPIRED</span>';
                    itemBgColor = '#fee2e2';
                } else if (isExpiringSoon) {
                    expiryText = `<span style="color: #f59e0b; font-weight: bold;">Expires in ${getDateDifferenceInDays(item.expiry)} days</span>`;
                    itemBgColor = '#fef3c7';
                } else if (item.expiry) {
                    expiryText = `<span style="color: #10b981;">Until ${item.expiry}</span>`;
                }

                const itemDiv = document.createElement('div');
                const isLeftColumn = index % 2 === 0;
                const borderStyle = `border-bottom: 1px solid #ddd; ${isLeftColumn ? 'border-right: 1px solid #ddd;' : ''}`;
                itemDiv.style.cssText = `background: ${itemBgColor}; padding: 8px; ${borderStyle}`;
                itemDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 0;">
                            <input type="checkbox" ${selected ? 'checked' : ''} onchange="window.toggleInventorySelection('${item.id}')" style="margin: 0; width: 20px; height: 20px; cursor: pointer; accent-color: #6366f1;">
                            <div style="width: 40px; height: 40px;">
                                <img src="${getItemImage(item.name)}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: contain;">
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: bold; font-size: 16px; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word;">${item.name}</div>
                            <div style="font-size: 12px;">${expiryText || 'No expiry'}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0;">
                            <a onclick="event.preventDefault(); window.adjustQuantity('${item.id}', -1)" style="cursor: pointer;">
                                <img src="img/quantity-btn-down.jpg" alt="-" style="height: 32px;">
                            </a>
                            <span style="min-width: 20px; text-align: center; font-weight: 600; font-size: 16px; padding: 0;">${item.quantity || 1}</span>
                            <a onclick="event.preventDefault(); window.adjustQuantity('${item.id}', 1)" style="cursor: pointer;">
                                <img src="img/quantity-btn-up.jpg" alt="+" style="height: 32px;">
                            </a>
                        </div>
                        <a onclick="event.preventDefault(); window.showEditItemNameModal('${item.id}')" style="cursor: pointer;">
                            <img src="img/edit.jpg" alt="Edit" style="height: 28px;">
                        </a>
                        <a onclick="event.preventDefault(); window.showEditExpiryModal('${item.id}', '${item.name}')" style="cursor: pointer;">
                            <img src="img/date.jpg" alt="Date" style="height: 28px;">
                        </a>
                    </div>
                `;
                gridContainer.appendChild(itemDiv);
            });

            listEl.appendChild(gridContainer);

            const deleteBtn = document.getElementById('delete-selected-btn');
            if (deleteBtn) {
                deleteBtn.disabled = window.selectedInventoryIds.size === 0;
            }
        };

        window.renderSavedRecipes = () => {
            const listEl = document.getElementById('saved-recipes-list');
            if (!listEl) return;
            listEl.innerHTML = '<ul></ul>';
            const ul = listEl.querySelector('ul');

            if (!window.savedRecipes || window.savedRecipes.length === 0) {
                ul.innerHTML = '<li class="item-content"><div class="item-inner"><div class="item-title" style="white-space: normal;">You haven\'t saved any recipes yet.</div></div></li>';
                return;
            }

            window.savedRecipes.forEach(recipe => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="item-content">
                        <div class="item-inner" style="display: flex; flex-direction: column; align-items: center;">
                            <div class="item-title" style="cursor: pointer; width: 100%; text-align: center;">${recipe.title}</div>
                            <div style="width: 100%; display: flex; justify-content: center; margin-top: 6px;">
                                <a href="#" class="remove-recipe-btn">Remove</a>
                            </div>
                        </div>
                    </div>
                `;
                // Add click handler to the title for viewing recipe
                li.querySelector('.item-title').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.viewSavedRecipe(recipe);
                });
                // Add click handler for remove button
                li.querySelector('.remove-recipe-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.deleteSavedRecipe(recipe.id);
                });
                ul.appendChild(li);
            });
        };

        window.deleteSavedRecipe = async function(recipeId) {
            if (!window.currentUserId || !window.db) return;
            
            try {
                const collectionPath = `artifacts/${appId}/users/${window.currentUserId}/saved_recipes`;
                const recipeDocRef = doc(window.db, collectionPath, recipeId);
                await deleteDoc(recipeDocRef);
                
                app.toast.create({
                    text: 'Recipe deleted!',
                    closeTimeout: 2000,
                }).open();
            } catch (e) {
                console.error('Error deleting recipe:', e);
                app.dialog.alert('Failed to delete recipe', 'Error');
            }
        };

        window.viewSavedRecipe = function(recipe) {
            // Store recipe in global variable for schedule/mark as made functions
            window.currentSavedRecipe = {
                title: recipe.title,
                content: recipe.content
            };
            
            // Escape HTML to prevent breaking the template
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            const escapedTitle = escapeHtml(recipe.title);
            const escapedContent = escapeHtml(recipe.content);
            
            const popup = app.popup.create({
                content: `
                    <div class="popup">
                        <div class="page">
                            <div class="navbar">
                                <div class="navbar-bg"></div>
                                <div class="navbar-inner">
                                    <div class="title">${escapedTitle}</div>
                                    <div class="right">
                                        <a href="#" class="link popup-close">Close</a>
                                    </div>
                                </div>
                            </div>
                            <div class="page-content">
                                <div class="block" style="text-align: center; margin-top: 8px;">
                                    <button class="button button-fill" onclick="window.scheduleSavedRecipe()" style="background: #6366f1; color: white; font-size: 16px; font-weight: bold; margin-bottom: 8px;">Add to Schedule</button>
                                    <button class="button button-fill" onclick="window.deductInventory()" style="background: #10b981; color: white; font-size: 16px; font-weight: bold;">Mark as Made</button>
                                </div>
                                <div class="block">
                                    <pre style="white-space: pre-wrap; font-family: inherit; font-size: 14px; line-height: 1.5;">${escapedContent}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                on: {
                    closed: function() {
                        this.destroy();
                        if (window.currentRecipePopup === this) {
                            window.currentRecipePopup = null;
                        }
                    }
                }
            });
            
            // Close previous popup if open
            if (window.currentRecipePopup) {
                window.currentRecipePopup.close();
            }
            
            window.currentRecipePopup = popup;
            popup.open();
        };
        
        window.scheduleSavedRecipe = function() {
            if (!window.currentSavedRecipe) return;
            
            const today = new Date();
            const dates = [];
            
            // Generate next 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[date.getDay()];
                dates.push({ date: dateStr, label: `${dayName} (${dateStr})` });
            }
            
            // Create action sheet with date options using proper Framework7 structure
            const buttons = [
                [{
                    text: 'Select a day to schedule this recipe:',
                    label: true,
                    color: 'purple',
                    bold: true
                }],
                dates.map(d => ({
                    text: d.label,
                    color: 'green',
                    onClick: async () => {
                        const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
                        const scheduleDocRef = window.doc(window.db, scheduleCollectionPath, 'schedule');
                        
                        try {
                            const docSnap = await window.getDoc(scheduleDocRef);
                            let currentSchedule = {};
                            if (docSnap.exists()) {
                                currentSchedule = docSnap.data().schedule || {};
                            }
                            
                            currentSchedule[d.date] = {
                                recipeTitle: window.currentSavedRecipe.title,
                                recipeContent: window.currentSavedRecipe.content,
                                date: d.date
                            };
                            
                            await window.setDoc(scheduleDocRef, { schedule: currentSchedule });
                            
                            window.app.toast.create({
                                text: `Scheduled for ${d.label}!`,
                                closeTimeout: 2000,
                            }).open();
                        } catch (e) {
                            console.error('Error scheduling meal:', e);
                            window.app.dialog.alert('Failed to schedule meal', 'Error');
                        }
                    }
                })),
                [{
                    text: 'Cancel',
                    color: 'red'
                }]
            ];
            
            const actions = window.app.actions.create({
                buttons: buttons
            });
            actions.open();
        };

        window.renderShoppingList = () => {
            const listEl = document.getElementById('shopping-list');
            if (!listEl) return;
            listEl.innerHTML = '<ul></ul>';
            const ul = listEl.querySelector('ul');
            window.shoppingList.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title">${item.name}</div>
                            <div class="item-after">
                                <a href="#" onclick="window.removeShoppingItem('${item.id}'); return false;" class="button button-small button-fill color-red">Remove</a>
                            </div>
                        </div>
                    </div>
                `;
                ul.appendChild(li);
            });
        };

        window.renderSchedule = () => {
            const container = document.getElementById('calendar-container');
            if (!container) return;
            
            // Get today and next 6 days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            container.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[date.getDay()];
                
                const scheduled = window.mealSchedule[dateStr];
                const recipeTitle = scheduled ? scheduled.recipeTitle : 'No meal planned';
                const hasScheduled = scheduled && scheduled.recipeTitle;
                
                const dayBox = document.createElement('div');
                dayBox.style.cssText = 'margin-bottom: 12px;';
                dayBox.innerHTML = `
                    <div style="position: relative;">
                        <img src="img/schedulebox.jpg" alt="${dayName}" style="width: 100%; height: 150px; display: block; border-radius: 8px; object-fit: cover; cursor: pointer;" onclick="${hasScheduled ? `window.viewScheduledRecipe('${dateStr}')` : `window.showScheduleModal('${dateStr}', '${dayName}')`}">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 16px; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); pointer-events: none;">
                            <div style="font-size: 20px; font-weight: bold;">${dayName}</div>
                            <div style="font-size: 16px; margin-top: 4px;">${dateStr}</div>
                            <div style="font-size: 14px; margin-top: 8px; font-style: italic;">${recipeTitle}</div>
                        </div>
                        ${hasScheduled ? `
                            <div style="display: flex; gap: 8px; justify-content: center; margin-top: 8px;">
                                <button class="button button-small button-fill" onclick="event.stopPropagation(); window.removeScheduledMeal('${dateStr}')" style="background: #ef4444; color: white; font-size: 14px; font-weight: bold;">Remove</button>
                                <button class="button button-small button-fill" onclick="event.stopPropagation(); window.markScheduledMealAsMade('${dateStr}')" style="background: #10b981; color: white; font-size: 14px; font-weight: bold;">Mark as Made</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(dayBox);
            }
        };
        
        window.showScheduleModal = (dateStr, dayName) => {
            const scheduled = window.mealSchedule[dateStr];
            const currentRecipe = scheduled ? scheduled.recipeTitle : '';
            
            app.dialog.prompt(
                `Enter recipe for ${dayName} (${dateStr}):`,
                'Schedule Meal',
                async (recipeTitle) => {
                    if (!recipeTitle || !recipeTitle.trim()) return;
                    
                    const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
                    const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');
                    
                    try {
                        const docSnap = await getDoc(scheduleDocRef);
                        let currentSchedule = {};
                        if (docSnap.exists()) {
                            currentSchedule = docSnap.data().schedule || {};
                        }
                        
                        currentSchedule[dateStr] = {
                            recipeTitle: recipeTitle.trim(),
                            recipeContent: null, // Manually added meals don't have content
                            date: dateStr
                        };
                        
                        await setDoc(scheduleDocRef, { schedule: currentSchedule });
                        
                        app.toast.create({
                            text: 'Meal scheduled!',
                            closeTimeout: 2000,
                        }).open();
                    } catch (e) {
                        console.error('Error scheduling meal:', e);
                        app.dialog.alert('Failed to schedule meal', 'Error');
                    }
                },
                () => {},
                currentRecipe
            );
        };
        
        window.viewScheduledRecipe = function(dateStr) {
            const scheduled = window.mealSchedule[dateStr];
            if (!scheduled || !scheduled.recipeContent) {
                app.dialog.alert('No recipe details available for this meal.', 'Info');
                return;
            }
            
            // Escape HTML to prevent breaking the template
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            const escapedTitle = escapeHtml(scheduled.recipeTitle);
            const escapedContent = escapeHtml(scheduled.recipeContent);
            
            const popup = app.popup.create({
                content: `
                    <div class="popup">
                        <div class="page">
                            <div class="navbar">
                                <div class="navbar-bg"></div>
                                <div class="navbar-inner">
                                    <div class="title">${escapedTitle}</div>
                                    <div class="right">
                                        <a href="#" class="link popup-close">Close</a>
                                    </div>
                                </div>
                            </div>
                            <div class="page-content">
                                <div class="block" style="text-align: center; margin-top: 8px;">
                                    <button class="button button-fill" onclick="window.removeScheduledMeal('${dateStr}')" style="background: #ef4444; color: white; font-size: 16px; font-weight: bold; margin-bottom: 8px;">Remove from Schedule</button>
                                    <button class="button button-fill" onclick="window.markScheduledMealAsMade('${dateStr}')" style="background: #10b981; color: white; font-size: 16px; font-weight: bold;">Mark as Made</button>
                                </div>
                                <div class="block">
                                    <pre style="white-space: pre-wrap; font-family: inherit; font-size: 14px; line-height: 1.5;">${escapedContent}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                on: {
                    closed: function() {
                        this.destroy();
                        if (window.currentRecipePopup === this) {
                            window.currentRecipePopup = null;
                        }
                    }
                }
            });
            
            // Close previous popup if open
            if (window.currentRecipePopup) {
                window.currentRecipePopup.close();
            }
            
            window.currentRecipePopup = popup;
            popup.open();
        };
        
        window.removeScheduledMeal = async function(dateStr) {
            app.dialog.confirm('Remove this scheduled meal?', 'Confirm', async () => {
                const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
                const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');
                
                try {
                    const docSnap = await getDoc(scheduleDocRef);
                    let currentSchedule = {};
                    if (docSnap.exists()) {
                        currentSchedule = docSnap.data().schedule || {};
                    }
                    
                    delete currentSchedule[dateStr];
                    
                    await setDoc(scheduleDocRef, { schedule: currentSchedule });
                    
                    app.toast.create({
                        text: 'Meal removed from schedule!',
                        closeTimeout: 2000,
                    }).open();
                } catch (e) {
                    console.error('Error removing scheduled meal:', e);
                    app.dialog.alert('Failed to remove meal', 'Error');
                }
            });
        };
        
        window.markScheduledMealAsMade = async function(dateStr) {
            const scheduled = window.mealSchedule[dateStr];
            if (!scheduled) return;
            
            app.dialog.confirm(`Mark "${scheduled.recipeTitle}" as made and remove ingredients from inventory?`, 'Mark as Made', async () => {
                // Since we don't have the full recipe details in the schedule,
                // we'll just remove the meal from schedule
                const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
                const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');
                
                try {
                    const docSnap = await getDoc(scheduleDocRef);
                    let currentSchedule = {};
                    if (docSnap.exists()) {
                        currentSchedule = docSnap.data().schedule || {};
                    }
                    
                    delete currentSchedule[dateStr];
                    
                    await setDoc(scheduleDocRef, { schedule: currentSchedule });
                    
                    app.toast.create({
                        text: 'Meal marked as made!',
                        closeTimeout: 2000,
                    }).open();
                } catch (e) {
                    console.error('Error marking meal as made:', e);
                    app.dialog.alert('Failed to mark as made', 'Error');
                }
            });
        };
        
        window.addMissingIngredientsToShopping = async function() {
            // Get all scheduled meals
            const scheduledMeals = Object.values(window.mealSchedule);
            
            if (scheduledMeals.length === 0) {
                app.dialog.alert('No meals scheduled!', 'Info');
                return;
            }
            
            // Filter meals that have recipe content
            const mealsWithContent = scheduledMeals.filter(meal => meal.recipeContent);
            
            if (mealsWithContent.length === 0) {
                app.dialog.alert('No scheduled meals have recipe details. Only recipes added from the app (not manually entered) can have their ingredients extracted.', 'Info');
                return;
            }
            
            // Extract ingredients from all recipes
            const allIngredients = new Set();
            mealsWithContent.forEach(meal => {
                // Parse ingredients from recipe content
                const content = meal.recipeContent;
                
                // Look for the INGREDIENTS section
                const ingredientsMatch = content.match(/---\s*INGREDIENTS\s*---\s*([\s\S]*?)(?=---|\n\n|$)/i);
                if (ingredientsMatch) {
                    const ingredientsText = ingredientsMatch[1];
                    // Split by newlines and clean up
                    const ingredients = ingredientsText
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line && !line.startsWith('---'));
                    
                    ingredients.forEach(ingredient => {
                        if (ingredient) allIngredients.add(ingredient);
                    });
                }
            });
            
            if (allIngredients.size === 0) {
                app.dialog.alert('No ingredients could be extracted from scheduled recipes.', 'Info');
                return;
            }
            
            // Check which ingredients are missing from inventory
            const inventoryNames = window.inventory.map(item => normalizeItemName(item.name));
            const missingIngredients = Array.from(allIngredients).filter(ingredient => {
                // Extract just the ingredient name (remove quantities, etc.)
                const ingredientName = ingredient.replace(/^[-*]\s*/, '').split(/\s*[-]\s*/)[0].trim();
                const normalized = normalizeItemName(ingredientName);
                return !inventoryNames.some(invName => invName.includes(normalized) || normalized.includes(invName));
            });
            
            if (missingIngredients.length === 0) {
                app.dialog.alert('All ingredients from scheduled recipes are already in your inventory!', 'Success');
                return;
            }
            
            // Add missing ingredients to shopping list
            const newShoppingItems = missingIngredients.map(ingredient => ({
                id: generateId(),
                name: ingredient
            }));
            
            const updatedList = [...window.shoppingList, ...newShoppingItems];
            await window.saveShoppingListToDb(updatedList);
            
            app.toast.create({
                text: `Added ${missingIngredients.length} missing ingredient${missingIngredients.length > 1 ? 's' : ''} to shopping list!`,
                closeTimeout: 3000,
            }).open();
        };

        // Inventory CRUD
        window.toggleInventorySelection = (id) => {
            if (window.selectedInventoryIds.has(id)) {
                window.selectedInventoryIds.delete(id);
            } else {
                window.selectedInventoryIds.add(id);
            }
            window.renderInventory();
        };

        window.deleteSelectedItems = () => {
            if (window.selectedInventoryIds.size === 0) return;
            const idsToRemove = Array.from(window.selectedInventoryIds);
            const newInventory = window.inventory.filter(item => !idsToRemove.includes(item.id));
            window.selectedInventoryIds.clear();
            window.saveInventoryToDb(newInventory);
        };

        window.removeAllItems = () => {
            if (window.inventory.length === 0) return;
            app.dialog.confirm('Remove all items from inventory?', 'Confirm', () => {
                window.saveInventoryToDb([]);
            });
        };

        window.addManualItem = () => {
            const inputEl = document.getElementById('manual-item-input');
            const expiryEl = document.getElementById('manual-expiry-input');
            const name = inputEl.value.trim();
            const expiry = expiryEl.value || null;

            if (name) {
                const newItem = { id: generateId(), name: name, expiry: expiry, quantity: 1 };
                window.appendItemsToInventory([newItem]);
                inputEl.value = '';
                expiryEl.value = '';
            }
        };

        window.adjustQuantity = (id, delta) => {
            const itemIndex = window.inventory.findIndex(item => item.id === id);
            if (itemIndex === -1) return;

            const newInventory = JSON.parse(JSON.stringify(window.inventory));
            const currentQty = newInventory[itemIndex].quantity || 1;
            const newQty = Math.max(1, currentQty + delta);

            newInventory[itemIndex].quantity = newQty;
            window.saveInventoryToDb(newInventory);
        };

        window.showEditItemNameModal = (id) => {
            const item = window.inventory.find(i => i.id === id);
            if (!item) return;

            app.dialog.prompt('Edit item name:', 'Edit Item', (value) => {
                if (!value.trim()) return;
                const itemIndex = window.inventory.findIndex(i => i.id === id);
                if (itemIndex >= 0) {
                    const newInventory = JSON.parse(JSON.stringify(window.inventory));
                    newInventory[itemIndex].name = value.trim();
                    window.saveInventoryToDb(newInventory);
                }
            }, () => {}, item.name);
        };

        window.showEditExpiryModal = (id, itemName) => {
            const item = window.inventory.find(i => i.id === id);
            if (!item) return;

            app.dialog.prompt('Enter expiry date (YYYY-MM-DD):', itemName, (value) => {
                const itemIndex = window.inventory.findIndex(i => i.id === id);
                if (itemIndex >= 0) {
                    const newInventory = JSON.parse(JSON.stringify(window.inventory));
                    newInventory[itemIndex].expiry = value || null;
                    window.saveInventoryToDb(newInventory);
                }
            }, () => {}, item.expiry || '');
        };

        // Scanner logic
        const imagePreviewEl = document.getElementById('scan-preview');
        const imagePlaceholderEl = document.getElementById('scan-placeholder');
        const scanStatusEl = document.getElementById('scan-status');
        const scanStatusTextEl = document.getElementById('scan-status-text');
        const scanErrorEl = document.getElementById('scan-error');
        const detectionResultEl = document.getElementById('detection-result');
        const detectedItemsListEl = document.getElementById('detected-items-list');

        document.getElementById('camera-input').addEventListener('change', handleImageInput);
        document.getElementById('file-input').addEventListener('change', handleImageInput);

        function handleImageInput(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreviewEl.src = event.target.result;
                    imagePreviewEl.style.display = 'block';
                    imagePlaceholderEl.style.display = 'none';
                    const base64String = event.target.result.split(',')[1];
                    window.latestImageBase64 = {
                        data: base64String,
                        mimeType: file.type
                    };
                };
                reader.readAsDataURL(file);
            }
            detectionResultEl.style.display = 'none';
            scanErrorEl.style.display = 'none';
        }

        window.processImageForInventory = async function() {
            if (!window.latestImageBase64) {
                app.dialog.alert('Please select an image first', 'Error');
                return;
            }

            scanStatusEl.style.display = 'block';
            detectionResultEl.style.display = 'none';
            scanErrorEl.style.display = 'none';

            const userQuery = "Analyze the contents of this image. Identify and list all visible food, drink, and cooking ingredients. For each item, list the name and estimate quantity or size.";

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    detectedIngredients: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "name": { "type": "STRING", "description": "The name of the detected food item with quantity." },
                                "confidence": { "type": "STRING", "description": "High, Medium, or Low" }
                            },
                            required: ["name", "confidence"]
                        }
                    }
                }
            };

            const payload = {
                modelName: GEMINI_VISION_MODEL,
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: window.latestImageBase64.mimeType,
                                data: window.latestImageBase64.data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };

            try {
                const result = await window.callGemini(payload);
                const responseData = result?.data?.result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (responseData) {
                    let parsedJson;
                    try {
                        const cleaned = responseData.replace(/^```json\s*/i, '').replace(/```\s*$/, '').trim();
                        parsedJson = JSON.parse(cleaned);
                    } catch (e) {
                        throw new Error("Invalid JSON structure.");
                    }

                    window.renderDetectedItems(parsedJson.detectedIngredients || []);
                } else {
                    throw new Error("Empty response from vision model.");
                }
            } catch (error) {
                scanErrorEl.textContent = 'Error: ' + error.message;
                scanErrorEl.style.display = 'block';
            }

            scanStatusEl.style.display = 'none';
        };

        window.renderDetectedItems = (items) => {
            detectedItemsListEl.innerHTML = '';

            const currentNames = window.inventory.map(item => item.name.toLowerCase());
            const newItems = items.filter(item => !currentNames.includes(item.name.toLowerCase()));

            window.itemsToSave = newItems;

            if (newItems.length === 0) {
                detectionResultEl.style.display = 'none';
                return;
            }

            newItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <label class="item-checkbox item-content">
                        <input type="checkbox" checked data-name="${item.name}">
                        <i class="icon icon-checkbox"></i>
                        <div class="item-inner">
                            <div class="item-title">${item.name}</div>
                            <div class="item-after">${item.confidence}</div>
                        </div>
                    </label>
                `;
                detectedItemsListEl.appendChild(li);
            });

            detectionResultEl.style.display = 'block';
        };

        window.saveDetectedInventory = function() {
            const checkboxes = detectedItemsListEl.querySelectorAll('input[type="checkbox"]:checked');

            const itemsToAdd = Array.from(checkboxes)
                .map(cb => cb.dataset.name.trim())
                .filter(name => name.length > 0);

            if (itemsToAdd.length === 0) return;

            const newItems = itemsToAdd.map(name => ({ id: generateId(), name: name, expiry: null, quantity: 1 }));
            window.appendItemsToInventory(newItems);

            // Reset scanner
            imagePreviewEl.style.display = 'none';
            imagePlaceholderEl.style.display = 'block';
            detectionResultEl.style.display = 'none';
            window.latestImageBase64 = null;

            app.toast.create({
                text: `Added ${newItems.length} items to inventory`,
                closeTimeout: 2000,
            }).open();
        };

        // Shopping list functions
        window.addShoppingItem = function() {
            const input = document.getElementById('shopping-item-input');
            const name = input.value.trim();
            if (name) {
                const newItem = { id: generateId(), name: name };
                const newList = [...window.shoppingList, newItem];
                window.saveShoppingListToDb(newList);
                input.value = '';
            }
        };

        window.removeShoppingItem = function(id) {
            const newList = window.shoppingList.filter(item => item.id !== id);
            window.saveShoppingListToDb(newList);
        };

        // Recipe functions
        window.toggleUnits = function(unit) {
            window.units = unit;
            const buttons = document.querySelectorAll('[data-unit]');
            buttons.forEach(btn => {
                if (btn.dataset.unit === unit) {
                    btn.classList.add('button-active');
                } else {
                    btn.classList.remove('button-active');
                }
            });
        };

        const formatRecipeContent = (recipe) => {
            const content = `
Recipe Name: ${recipe.recipeName}

--- INGREDIENTS ---
${recipe.ingredientsSummary}

--- INSTRUCTIONS ---
${recipe.instructions}

${recipe.missingIngredients && recipe.missingIngredients.length > 0 ? '\n--- MISSING INGREDIENTS ---\n' + recipe.missingIngredients.join('\n') : ''}
`;
            return content.trim();
        };

        window.generateRecipes = async function() {
            if (window.inventory.length === 0) {
                app.dialog.alert('Your pantry is empty! Please add items first.', 'Error');
                return;
            }

            const statusEl = document.getElementById('recipe-generation-status');
            const listEl = document.getElementById('recipe-list-view');
            statusEl.style.display = 'block';
            listEl.innerHTML = '';

            const maxCookTime = document.getElementById('max-cook-time').value;
            const maxIngredients = document.getElementById('max-ingredients').value;
            const allowMissingIngredients = document.getElementById('allow-missing-ingredients').checked;
            const dietaryRestrictions = document.getElementById('dietary-restrictions').value.trim();

            const inventoryList = window.inventory.map(item => {
                let s = item.name;
                if (item.quantity > 1) s += ` (x${item.quantity})`;
                if (item.expiry) s += ` (Expires ${item.expiry})`;
                return s;
            }).join(', ');

            const unitPreference = window.units === 'metric' ?
                'Use Metric measurements (grams, milliliters, Celsius)' :
                'Use Standard US measurements (ounces, cups, Fahrenheit)';

            // Add randomization element
            const cuisineStyles = ['Italian', 'Mexican', 'Asian', 'Mediterranean', 'American', 'Indian', 'Thai', 'French', 'Middle Eastern', 'Fusion'];
            const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack', 'appetizer', 'soup', 'salad', 'main course', 'side dish'];
            const cookingMethods = ['grilled', 'baked', 'sauted', 'roasted', 'stir-fried', 'steamed', 'pan-fried', 'slow-cooked'];
            
            const randomCuisine = cuisineStyles[Math.floor(Math.random() * cuisineStyles.length)];
            const randomMeal = mealTypes[Math.floor(Math.random() * mealTypes.length)];
            const randomMethod = cookingMethods[Math.floor(Math.random() * cookingMethods.length)];
            const randomSeed = Math.floor(Math.random() * 100000);

            let systemPrompt = `You are a world-class chef. ${unitPreference}. Cooking time under ${maxCookTime} minutes. Max ${maxIngredients} ingredients. `;
            systemPrompt += `IMPORTANT: Be creative and VARY your suggestions. Random seed: ${randomSeed}. Consider incorporating ${randomCuisine} flavors, ${randomMeal} options, or ${randomMethod} techniques where appropriate. `;

            if (dietaryRestrictions) {
                systemPrompt += `IMPORTANT: Dietary restrictions - ${dietaryRestrictions}. All recipes MUST comply with these restrictions. `;
            }

            if (allowMissingIngredients) {
                systemPrompt += `Generate 3 DIFFERENT and VARIED recipes using available inventory, but you may include common missing ingredients. Mark which are AVAILABLE vs MISSING.`;
            } else {
                systemPrompt += `Generate 3 DIFFERENT and VARIED recipes using ONLY the ingredients from inventory.`;
            }

            const userQuery = `My pantry: ${inventoryList}. Generate 3 recipes.`;

            const recipeSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "recipeName": { "type": "STRING" },
                        "ingredientsSummary": { "type": "STRING" },
                        "instructions": { "type": "STRING" },
                        "deductibleInventoryStrings": { 
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        },
                        "missingIngredients": {
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        }
                    },
                    required: ["recipeName", "ingredientsSummary", "instructions", "deductibleInventoryStrings"]
                }
            };

            const payload = {
                modelName: GEMINI_TEXT_MODEL,
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: recipeSchema,
                    temperature: 1.5,  // Higher temperature for more variety and creativity
                    topP: 0.95,
                    topK: 40
                }
            };

            try {
                const result = await window.callGemini(payload);
                const responseData = result?.data?.result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (responseData) {
                    let parsedJson;
                    try {
                        const cleaned = responseData.replace(/^```json\s*/i, '').replace(/```\s*$/, '').trim();
                        parsedJson = JSON.parse(cleaned);
                    } catch (e) {
                        throw new Error("Invalid JSON from AI.");
                    }

                    window.latestGeneratedRecipes = parsedJson;
                    renderGeneratedRecipesList();
                } else {
                    throw new Error("Empty response from AI.");
                }
            } catch (error) {
                app.dialog.alert('Recipe generation failed: ' + error.message, 'Error');
            }

            statusEl.style.display = 'none';
        };

        function renderGeneratedRecipesList() {
            const listEl = document.getElementById('recipe-list-view');
            listEl.innerHTML = '<ul style="padding-left: 0; margin-left: 0;"></ul>';
            const ul = listEl.querySelector('ul');

            window.latestGeneratedRecipes.forEach((recipe, index) => {
                const li = document.createElement('li');
                li.style.cssText = 'text-align: left;';
                li.innerHTML = `
                    <a href="#" class="item-link item-content" style="text-align: left;">
                        <div class="item-inner" style="text-align: left;">
                            <div class="item-title" style="font-size: 18px; font-weight: bold;">${recipe.recipeName}</div>
                        </div>
                    </a>
                `;
                li.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    viewGeneratedRecipe(index);
                });
                ul.appendChild(li);
            });
        }

        function viewGeneratedRecipe(index) {
            const recipe = window.latestGeneratedRecipes[index];
            if (!recipe) return;

            window.selectedGeneratedRecipeIndex = index;
            const content = formatRecipeContent(recipe);

            // Create a Framework7 popup instead of a sheet
            const popup = app.popup.create({
                content: `
                    <div class="popup">
                        <div class="page">
                            <div class="navbar">
                                <div class="navbar-bg"></div>
                                <div class="navbar-inner">
                                    <div class="title">${recipe.recipeName}</div>
                                    <div class="right">
                                        <a href="#" class="link popup-close">Close</a>
                                    </div>
                                </div>
                            </div>
                            <div class="page-content">
                                <div class="block" style="text-align: center; margin-top: 8px;">
                                    <button class="button button-fill" onclick="window.saveCurrentRecipe()" style="background: #6366f1; color: white; font-size: 16px; font-weight: bold; margin-bottom: 8px;">Save Recipe</button>
                                    <button class="button button-fill" onclick="window.scheduleGeneratedRecipe(${index})" style="background: #6366f1; color: white; font-size: 16px; font-weight: bold; margin-bottom: 8px;">Add to Schedule</button>
                                    <button class="button button-fill" onclick="window.deductInventory()" style="background: #10b981; color: white; font-size: 16px; font-weight: bold;">Mark as Made</button>
                                </div>
                                <div class="block">
                                    <pre style="white-space: pre-wrap; font-family: inherit; font-size: 14px; line-height: 1.5;">${content}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                on: {
                    closed: function() {
                        this.destroy();
                        if (window.currentRecipePopup === this) {
                            window.currentRecipePopup = null;
                        }
                    }
                }
            });
            // Close previous popup if open
            if (window.currentRecipePopup) {
                window.currentRecipePopup.close();
            }
            window.currentRecipePopup = popup;
            popup.open();
        }

        window.saveCurrentRecipe = async function() {
            if (window.selectedGeneratedRecipeIndex === null) return;
            const recipe = window.latestGeneratedRecipes[window.selectedGeneratedRecipeIndex];
            if (!recipe) return;

            const content = formatRecipeContent(recipe);
            await window.saveGeneratedRecipeToDb(recipe.recipeName, content);
            app.toast.create({
                text: 'Recipe saved!',
                closeTimeout: 2000,
            }).open();
        };

        window.saveGeneratedRecipeToDb = async (title, content) => {
            if (!window.currentUserId || !window.db) return false;
            const collectionPath = `artifacts/${appId}/users/${window.currentUserId}/saved_recipes`;
            const recipesCollectionRef = collection(window.db, collectionPath);
            try {
                await addDoc(recipesCollectionRef, {
                    title: title,
                    content: content,
                    createdAt: new Date().toISOString()
                });
                return true;
            } catch (e) {
                console.error("Error saving recipe:", e);
                return false;
            }
        };

        window.deductInventory = function() {
            if (window.selectedGeneratedRecipeIndex === null) return;
            const recipe = window.latestGeneratedRecipes[window.selectedGeneratedRecipeIndex];

            if (!recipe || !Array.isArray(recipe.deductibleInventoryStrings)) return;

            const itemsToDeduct = recipe.deductibleInventoryStrings.map(s => normalizeItemName(s));

            if (itemsToDeduct.length === 0) {
                app.dialog.alert('No items to deduct', 'Info');
                return;
            }

            let newInventory = JSON.parse(JSON.stringify(window.inventory));

            itemsToDeduct.forEach(deductName => {
                const index = newInventory.findIndex(item => normalizeItemName(item.name) === deductName);
                if (index !== -1) {
                    if (newInventory[index].quantity > 1) {
                        newInventory[index].quantity -= 1;
                    } else {
                        newInventory.splice(index, 1);
                    }
                }
            });

            window.saveInventoryToDb(newInventory);
            app.toast.create({
                text: 'Inventory updated!',
                closeTimeout: 2000,
            }).open();
        };

        window.scheduleRecipeModal = function() {
            if (window.selectedGeneratedRecipeIndex === null) return;
            const recipe = window.latestGeneratedRecipes[window.selectedGeneratedRecipeIndex];
            if (!recipe) return;

            // Use existing schedule modal from calendar
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
            window.showScheduleModal(dateStr, dayName);
        };

        async function scheduleRecipe(title, content, date) {
            if (!window.currentUserId || !window.db) return;
            const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
            const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');

            try {
                const docSnap = await getDoc(scheduleDocRef);
                let currentSchedule = {};
                if (docSnap.exists()) {
                    currentSchedule = docSnap.data().schedule || {};
                }

                currentSchedule[date] = {
                    recipeTitle: title,
                    recipeContent: content
                };

                await setDoc(scheduleDocRef, { schedule: currentSchedule });
            } catch (e) {
                console.error("Error scheduling recipe:", e);
            }
        }

        window.scheduleGeneratedRecipe = function(index) {
            const recipe = window.latestGeneratedRecipes[index];
            if (!recipe) return;
            
            const today = new Date();
            const dates = [];
            
            // Generate next 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[date.getDay()];
                dates.push({ date: dateStr, label: `${dayName} (${dateStr})` });
            }
            
            // Create action sheet with date options
            const buttons = dates.map(d => ({
                text: d.label,
                onClick: async () => {
                    const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
                    const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');
                    
                    try {
                        const docSnap = await getDoc(scheduleDocRef);
                        let currentSchedule = {};
                        if (docSnap.exists()) {
                            currentSchedule = docSnap.data().schedule || {};
                        }
                        
                        const content = formatRecipeContent(recipe);
                        currentSchedule[d.date] = {
                            recipeTitle: recipe.recipeName,
                            recipeContent: content,
                            date: d.date
                        };
                        
                        await setDoc(scheduleDocRef, { schedule: currentSchedule });
                        
                        app.toast.create({
                            text: `Scheduled for ${d.label}!`,
                            closeTimeout: 2000,
                        }).open();
                    } catch (e) {
                        console.error('Error scheduling meal:', e);
                        app.dialog.alert('Failed to schedule meal', 'Error');
                    }
                }
            }));
            
            buttons.push({
                text: 'Cancel',
                color: 'red'
            });
            
            app.actions.create({
                buttons: buttons
            }).open();
        };


        window.searchRecipes = async function() {
            const input = document.getElementById('recipe-search-input');
            const searchQuery = input.value.trim();
            
            if (!searchQuery) {
                app.dialog.alert('Please enter a recipe name to search', 'Info');
                return;
            }
            
            const statusEl = document.getElementById('recipe-generation-status');
            const listEl = document.getElementById('recipe-list-view');
            statusEl.style.display = 'block';
            listEl.innerHTML = '';
            
            const unitPreference = window.units === 'metric' ?
                'Use Metric measurements (grams, milliliters, Celsius)' :
                'Use Standard US measurements (ounces, cups, Fahrenheit)';
            
            const systemPrompt = `You are a world-class chef. ${unitPreference}. Provide a complete recipe with ingredients and step-by-step instructions.`;
            const userQuery = `Provide a detailed recipe for: ${searchQuery}`;
            
            const recipeSchema = {
                type: "OBJECT",
                properties: {
                    "recipeName": { "type": "STRING" },
                    "ingredientsSummary": { "type": "STRING", "description": "Formatted list of all ingredients with quantities" },
                    "instructions": { "type": "STRING", "description": "Step-by-step cooking instructions" },
                    "cookTime": { "type": "STRING", "description": "Estimated cooking time" },
                    "servings": { "type": "STRING", "description": "Number of servings" }
                },
                required: ["recipeName", "ingredientsSummary", "instructions"]
            };
            
            const payload = {
                modelName: GEMINI_TEXT_MODEL,
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: recipeSchema
                }
            };
            
            try {
                const result = await window.callGemini(payload);
                const responseData = result?.data?.result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (responseData) {
                    let parsedJson;
                    try {
                        const cleaned = responseData.replace(/^```json\s*/i, '').replace(/```\s*$/, '').trim();
                        parsedJson = JSON.parse(cleaned);
                    } catch (e) {
                        throw new Error("Invalid JSON structure.");
                    }
                    
                    // Display the recipe
                    const recipe = parsedJson;
                    const content = `
Recipe Name: ${recipe.recipeName}
${recipe.cookTime ? '\nCook Time: ' + recipe.cookTime : ''}
${recipe.servings ? 'Servings: ' + recipe.servings : ''}

--- INGREDIENTS ---
${recipe.ingredientsSummary}

--- INSTRUCTIONS ---
${recipe.instructions}
`;
                    
                    // Store for schedule/save functions
                    window.currentSearchedRecipe = {
                        title: recipe.recipeName,
                        content: content
                    };
                    
                    const popup = app.popup.create({
                        content: `
                            <div class="popup">
                                <div class="page">
                                    <div class="navbar">
                                        <div class="navbar-bg"></div>
                                        <div class="navbar-inner">
                                            <div class="title">${recipe.recipeName}</div>
                                            <div class="right">
                                                <a href="#" class="link popup-close">Close</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="page-content">
                                        <div class="block" style="text-align: center; margin-top: 8px;">
                                            <button class="button button-fill" onclick="window.saveSearchedRecipe()" style="background: #6366f1; color: white; font-size: 16px; font-weight: bold; margin-bottom: 8px;">Save Recipe</button>
                                            <button class="button button-fill" onclick="window.scheduleSearchedRecipe()" style="background: #6366f1; color: white; font-size: 16px; font-weight: bold; margin-bottom: 8px;">Add to Schedule</button>
                                        </div>
                                        <div class="block">
                                            <pre style="white-space: pre-wrap; font-family: inherit; font-size: 14px;">${content}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `,
                        on: {
                            closed: function() {
                                this.destroy();
                                if (window.currentRecipePopup === this) {
                                    window.currentRecipePopup = null;
                                }
                            }
                        }
                    });
                    // Close previous popup if open
                    if (window.currentRecipePopup) {
                        window.currentRecipePopup.close();
                    }
                    window.currentRecipePopup = popup;
                    popup.open();
                    // Store for potential saving
                    window.currentSearchedRecipe = { title: recipe.recipeName, content: content };
                } else {
                    throw new Error("Empty response from AI.");
                }
            } catch (error) {
                app.dialog.alert('Recipe search failed: ' + error.message, 'Error');
            }
            
            statusEl.style.display = 'none';
        };
        
        window.saveSearchedRecipe = async function() {
            if (!window.currentSearchedRecipe) return;
            await window.saveGeneratedRecipeToDb(window.currentSearchedRecipe.title, window.currentSearchedRecipe.content);
            app.toast.create({
                text: 'Recipe saved!',
                closeTimeout: 2000,
            }).open();
        };
        
        window.scheduleSearchedRecipe = function() {
            if (!window.currentSearchedRecipe) return;
            
            const today = new Date();
            const dates = [];
            
            // Generate next 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[date.getDay()];
                dates.push({ date: dateStr, label: `${dayName} (${dateStr})` });
            }
            
            // Create action sheet with date options
            const buttons = dates.map(d => ({
                text: d.label,
                onClick: async () => {
                    const scheduleCollectionPath = `artifacts/${appId}/users/${window.currentUserId}/meal_schedule`;
                    const scheduleDocRef = doc(window.db, scheduleCollectionPath, 'schedule');
                    
                    try {
                        const docSnap = await getDoc(scheduleDocRef);
                        let currentSchedule = {};
                        if (docSnap.exists()) {
                            currentSchedule = docSnap.data().schedule || {};
                        }
                        
                        currentSchedule[d.date] = {
                            recipeTitle: window.currentSearchedRecipe.title,
                            recipeContent: window.currentSearchedRecipe.content,
                            date: d.date
                        };
                        
                        await setDoc(scheduleDocRef, { schedule: currentSchedule });
                        
                        app.toast.create({
                            text: `Scheduled for ${d.label}!`,
                            closeTimeout: 2000,
                        }).open();
                    } catch (e) {
                        console.error('Error scheduling meal:', e);
                        app.dialog.alert('Failed to schedule meal', 'Error');
                    }
                }
            }));
            
            buttons.push({
                text: 'Cancel',
                color: 'red'
            });
            
            app.actions.create({
                buttons: buttons
            }).open();
        };

    </script>


</div>
</body>
</html>
